import{d as A,r as f,y as K,B as Q,c as i,g as d,a as e,u as o,h as W,w as X,b as g,C as G,l as J,t as l,f as I,e as p,s as y,D as U,n as D,F as _,i as N,q as Y,G as Z,H as F,o as r}from"./app-Dlk1-U9o.js";import{C as ee}from"./circle-alert-BtcyhYq9.js";import{L as w}from"./loader-circle-MU4xWfBI.js";import{R as te}from"./refresh-cw-D70oNmtT.js";import{T as se}from"./trash-2-xnYNepNO.js";import{X as re}from"./x-Du9Q9ljG.js";const oe={class:"p-6 max-w-2xl"},le={class:"mb-6"},ae={class:"flex justify-between items-start mb-6"},ne={class:"text-2xl font-bold text-gray-800 dark:text-white"},ie={class:"text-gray-500 dark:text-gray-400"},ce={class:"bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6"},ue={class:"flex items-center mb-4"},de={class:"mr-3"},ve={class:"text-lg font-semibold text-gray-800 dark:text-white"},ge={class:"text-gray-500 dark:text-gray-400"},pe={class:"mb-4"},he={class:"flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1"},me={class:"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5"},fe={key:0,class:"flex items-center text-sm font-medium text-blue-600 dark:text-blue-400 mb-4"},be={id:"provisioning-log",class:"bg-gray-100 dark:bg-gray-900 rounded-lg p-4 max-h-64 overflow-y-auto font-mono text-sm"},xe={key:1,class:"text-gray-500 dark:text-gray-400 pl-6"},ke={key:2,class:"flex items-center text-red-600 dark:text-red-400"},ye={key:1,class:"mt-4 flex space-x-3"},_e={class:"bg-white dark:bg-gray-800 rounded-lg shadow p-6"},we={class:"text-lg font-semibold text-gray-800 dark:text-white mb-4"},Pe={class:"space-y-2 text-gray-600 dark:text-gray-400"},Se={class:"mr-2"},Ce={key:2,class:"w-5 h-5 rounded-full border-2 border-gray-300"},Oe=A({__name:"Provisioning",props:{server:{},sshPublicKey:{}},setup(h){const n=h,b=f(n.server.status),u=f(n.server.provisioning_step??0),x=f(n.server.provisioning_total_steps??17),v=f(n.server.provisioning_log??[]),P=f(n.server.provisioning_error);let k=null,S=!1,C=0;const E=y(()=>x.value>0?Math.round(u.value/x.value*100):0),c=y(()=>b.value==="error"),R=y(()=>{const a=v.value.filter(t=>t.step);return a.length>0?a[a.length-1].step:"Starting..."}),j=[{step:3,label:"Orbit user with sudo access"},{step:6,label:"Secure SSH configuration (key-only, no root login)"},{step:8,label:"Docker with containerized services"},{step:11,label:"PHP-FPM 8.2, 8.3 & 8.4 via OndÅ™ej PPA"},{step:13,label:"Caddy web server"},{step:17,label:"Orbit stack (PostgreSQL, Redis, Mailpit)"}],$=[{step:2,label:"Homebrew package manager"},{step:3,label:"OrbStack (Docker for Mac)"},{step:5,label:"PHP 8.4 & 8.5 via Homebrew"},{step:6,label:"Caddy web server"},{step:9,label:"PHP-FPM pool configuration"},{step:11,label:"DNS resolver configuration"},{step:14,label:"Docker services (PostgreSQL, Redis, Mailpit)"},{step:15,label:"Horizon queue worker (launchd)"}],L=y(()=>n.server.is_local?$:j),M=a=>{if(u.value>=a)return"completed";const s=L.value.filter(m=>m.step<a).pop();return s&&u.value>=s.step?"in-progress":(u.value>0,"pending")};async function O(){if(!S){S=!0;try{await fetch(`/provision/${n.server.id}/run`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||"","Content-Type":"application/json"},body:JSON.stringify({ssh_public_key:n.sshPublicKey})})}catch(a){console.error("Provisioning start error:",a)}S=!1}}async function z(){try{const t=await(await fetch(`/provision/${n.server.id}/status`)).json();if(b.value=t.status,u.value=t.provisioning_step??0,x.value=t.provisioning_total_steps??17,P.value=t.provisioning_error,t.provisioning_log&&t.provisioning_log.length!==C){v.value=t.provisioning_log,C=t.provisioning_log.length,await Z();const s=document.getElementById("provisioning-log");s&&(s.scrollTop=s.scrollHeight)}t.status==="active"?(T(),window.location.reload()):t.status==="error"&&T()}catch(a){console.error("Status poll error:",a)}}function B(){k=setInterval(z,500)}function T(){k&&(clearInterval(k),k=null)}async function V(){b.value="provisioning",u.value=0,v.value=[],P.value=null,C=0,B(),await O()}function q(){confirm("Are you sure you want to delete this environment?")&&Y.delete(`/environments/${n.server.id}`)}return K(()=>{n.server.status==="provisioning"&&(B(),setTimeout(O,100))}),Q(()=>{T()}),(a,t)=>(r(),i(_,null,[d(o(W),{title:`${h.server.name} - Provisioning`},null,8,["title"]),e("div",oe,[e("div",le,[d(o(J),{href:"/servers",class:"text-blue-600 hover:text-blue-800 flex items-center"},{default:X(()=>[d(o(G),{class:"w-4 h-4 mr-1"}),t[0]||(t[0]=g(" Back to Environments ",-1))]),_:1})]),e("div",ae,[e("div",null,[e("h2",ne,l(h.server.name),1),e("p",ie,l(h.server.host),1)])]),e("div",ce,[e("div",ue,[e("div",de,[c.value?(r(),p(o(ee),{key:0,class:"w-8 h-8 text-red-500"})):(r(),p(o(w),{key:1,class:"w-8 h-8 text-blue-500 animate-spin"}))]),e("div",null,[e("h3",ve,l(c.value?"Provisioning Failed":"Setting up Environment"),1),e("p",ge,l(c.value?P.value:"Installing the Orbit stack on the remote machine..."),1)])]),e("div",pe,[e("div",he,[e("span",null,"Step "+l(u.value)+" of "+l(x.value),1),e("span",null,l(E.value)+"%",1)]),e("div",me,[e("div",{class:D(["h-2.5 rounded-full transition-all duration-300",c.value?"bg-red-500":"bg-blue-600"]),style:U({width:`${E.value}%`})},null,6)])]),c.value?I("",!0):(r(),i("div",fe,[d(o(w),{class:"w-4 h-4 mr-2 animate-spin"}),e("span",null,l(R.value),1)])),e("div",be,[(r(!0),i(_,null,N(v.value,(s,m)=>(r(),i(_,{key:m},[s.step?(r(),i("div",{key:0,class:D(["flex items-center",m===v.value.filter(H=>H.step).length-1&&!c.value?"text-blue-600 dark:text-blue-400":"text-green-600 dark:text-green-400"])},[m===v.value.filter(H=>H.step).length-1&&!c.value&&b.value==="provisioning"?(r(),p(o(w),{key:0,class:"w-4 h-4 mr-2 flex-shrink-0 animate-spin"})):(r(),p(o(F),{key:1,class:"w-4 h-4 mr-2 flex-shrink-0"})),g(" "+l(s.step),1)],2)):s.info?(r(),i("div",xe,l(s.info),1)):s.error?(r(),i("div",ke,[d(o(re),{class:"w-4 h-4 mr-2 flex-shrink-0"}),g(" "+l(s.error),1)])):I("",!0)],64))),128))]),c.value?(r(),i("div",ye,[e("button",{onClick:V,class:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center"},[d(o(te),{class:"w-4 h-4 mr-2"}),t[1]||(t[1]=g(" Retry Provisioning ",-1))]),e("button",{onClick:q,class:"px-4 py-2 border border-red-300 dark:border-red-600 text-red-600 dark:text-red-400 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/30"},[d(o(se),{class:"w-4 h-4 inline mr-2"}),t[2]||(t[2]=g(" Delete Environment ",-1))])])):I("",!0)]),e("div",_e,[e("h3",we,l(h.server.is_local?"What's being installed (Mac)":"What's being installed"),1),e("ul",Pe,[(r(!0),i(_,null,N(L.value,s=>(r(),i("li",{key:s.step,class:"flex items-center"},[e("span",Se,[M(s.step)==="completed"?(r(),p(o(F),{key:0,class:"w-5 h-5 text-green-500"})):M(s.step)==="in-progress"?(r(),p(o(w),{key:1,class:"w-5 h-5 text-blue-500 animate-spin"})):(r(),i("div",Ce))]),g(" "+l(s.label),1)]))),128))])])])],64))}});export{Oe as default};
