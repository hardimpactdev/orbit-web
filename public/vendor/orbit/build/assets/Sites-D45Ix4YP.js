import{I as ae,d as ye,W as we,k as R,M as m,y as ze,s as ee,c as l,g as o,a as i,u as a,h as Se,f as y,t as c,w as p,l as Ce,b as x,P as $e,r as u,X as De,F as H,i as te,o as n,e as r,O as Pe,U as Fe,n as Le,H as Ae,Y as Re,E as He}from"./app-Fw4JDgQl.js";import{a as N}from"./axios-Bjn8lbAm.js";import{_ as Ne}from"./Modal.vue_vue_type_script_setup_true_lang-DznOoOBp.js";import{I as h}from"./craft-ui-0ULiOxv_.js";import{C as se}from"./circle-alert-gRuzrr52.js";import{L as w}from"./loader-circle-CnT328Fr.js";import{G as ne}from"./globe-cqLxp4A8.js";import{T as ie}from"./trash-2-CX1s40HI.js";import{P as Ve}from"./package-L0jR0GX3.js";import{C as Ie}from"./code-D0PlfBSK.js";import{R as Ue}from"./refresh-cw-BgjcTmjp.js";const Te=ae("clock-3",[["path",{d:"M12 6v6h4",key:"135r8i"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);const M=ae("folder-open",[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]]),Ee={class:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-8"},Me={class:"text-sm text-zinc-500 mt-1"},Be={class:"flex items-center gap-2"},Oe={key:0,class:"mb-6 p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg flex items-start gap-3"},je={class:"text-zinc-400 text-sm mt-1"},qe={key:0},Ge={key:1},We={key:1,class:"rounded-lg border border-zinc-800 bg-zinc-900/50 p-8 text-center"},Qe={key:2,class:"rounded-lg border border-zinc-800 bg-zinc-900/50 p-8 text-center"},Xe={key:3,class:"rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden"},Ye={class:"flex items-center gap-3 min-w-0"},Je={class:"min-w-0"},Ke={class:"font-medium text-sm text-zinc-100 truncate"},Ze={key:0,class:"text-xs text-zinc-500 truncate"},et={class:"text-sm"},tt={key:0,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-lime-500/15 text-lime-400"},st={key:1,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-500/15 text-red-400"},nt={key:2,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-500/15 text-red-400"},it={key:3,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-500/15 text-red-400"},at={key:4,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-amber-500/15 text-amber-400"},lt={key:5,class:"text-zinc-500/50"},ot={key:0,class:"text-sm text-zinc-500 font-mono"},rt={key:1,class:"flex items-center gap-2"},dt=["value","onChange","disabled"],ct=["value"],ut={class:"flex items-center justify-end gap-1"},mt={key:0,class:"text-xs text-lime-400"},pt={key:1,class:"text-xs text-red-400"},ft={key:2,class:"text-xs text-zinc-500"},gt={class:"flex items-center gap-0.5 opacity-60 hover:opacity-100 transition-opacity"},vt={class:"flex items-center justify-between mt-4 px-1"},xt={class:"flex items-center gap-4 text-xs text-zinc-500"},ht={class:"flex items-center gap-1.5"},bt={class:"flex items-center gap-1.5"},_t={class:"flex items-center gap-1.5 text-xs"},kt={key:0,class:"inline-flex items-center gap-1.5 text-lime-400"},yt={key:1,class:"inline-flex items-center gap-1.5 text-amber-400"},wt={class:"p-6"},zt={class:"text-zinc-300 mb-4"},St={class:"text-white"},Ct={key:0,class:"mb-4 p-3 bg-red-400/10 border border-red-400/20 rounded-lg"},$t={class:"text-red-400 text-sm"},Dt={class:"flex justify-end gap-3"},Et=ye({__name:"Sites",props:{environment:{},editor:{},remoteApiUrl:{}},setup(z){const f=z,D=s=>f.remoteApiUrl?`${f.remoteApiUrl}${s}`:`/api/environments/${f.environment.id}${s}`,le=Pe(),B=u([]),oe=["queued","creating_repo","cloning","setting_up","installing_composer","installing_npm","building","finalizing"],V=u(!0),re=u("test"),P=u("8.4"),O=u(["8.3","8.4","8.5"]),I=u(null),j=ee(()=>{const s=new Map(B.value.map(e=>[e.name,e]));for(const[e,t]of U.value)s.has(e)||s.set(e,{id:0,name:e,path:`~/sites/${e}`,has_public_folder:!1,php_version:P.value,status:t.status});return Array.from(s.values()).sort((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))}),{provisioningSites:U,deletingSites:q,isConnected:G,connectionError:W,siteReadyCount:de,siteDeletedCount:ce,isConfigured:Q,trackSite:ue,getSiteStatus:me,trackDeletion:pe,getDeletionStatus:X,markDeletionComplete:fe,markDeletionFailed:Y}=we(),J=ee(()=>{const s=le.props.flash;return s?.provisioning?s.provisioning:new URLSearchParams(window.location.search).get("provisioning")}),K={queued:"Queued...",provisioning:"Initializing...",creating_repo:"Creating repository...",cloning:"Cloning...",setting_up:"Setting up...",installing_composer:"Installing Composer...",installing_npm:"Installing dependencies...",building:"Building assets...",finalizing:"Finalizing...",ready:"Ready",failed:"Failed"},ge={deleting:"Deleting...",removing_files:"Removing files...",deleted:"Deleted",delete_failed:"Delete failed"};function F(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")}function g(s){const e=F(s),t=X(e);return t?t.status!=="delete_failed":!1}function v(s){const e=F(s);return X(e)?.status??null}function Z(s){const e=s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),t=me(e);return t||(s.status&&oe.includes(s.status)?{slug:s.name,status:s.status,error:s.error_message??null,siteId:s.id}:null)}function b(s){const e=Z(s);return e?e.status!=="ready"&&e.status!=="failed":!1}function _(s){const e=Z(s);return e?.status==="ready"?null:e?.status??null}function T(s,e){const t=s||"Unknown error";if(t.includes("Connection error"))m.error("Connection Error",{description:"Could not connect to the environment. Check if Orbit is running."});else{const d=e.charAt(0).toUpperCase()+e.slice(1)+" Failed";m.error(d,{description:t})}}async function k(s=!1){s||(V.value=!0);try{const{data:e}=await N.get(D("/sites"));e.success&&e.data?(B.value=e.data.sites||[],re.value=e.data.tld||"test",P.value=e.data.default_php_version||"8.4",e.data.available_php_versions?.length&&(O.value=e.data.available_php_versions)):!e.success&&!s&&T(e.error,"load sites")}catch(e){if(Fe.isCancel(e))return;console.error("Failed to load sites:",e)}finally{s||(V.value=!1)}}function ve(s){const e=`https://${s}`;window.open(e,"_blank")}function xe(s){let e;if(f.environment.is_local)e=`${f.editor.scheme}://file${s}`;else{const t=`${f.environment.user}@${f.environment.host}`;e=`${f.editor.scheme}://vscode-remote/ssh-remote+${t}${s}?windowId=_blank`}window.open(e,"_blank")}async function he(s,e){if(s.domain){I.value=s.name;try{const{data:t}=await N.post(D(`/php/${s.name}`),{version:e});t.success?(m.success("PHP Version Changed",{description:`Now using PHP ${e} for this site.`}),await k(!0)):T(t.error,"change PHP version")}catch{}finally{I.value=null}}}const S=u(!1),C=u(null),$=u(!1),L=u(null);function be(s){C.value=s,L.value=null,S.value=!0}async function _e(){if(!C.value)return;const s=C.value.name,e=F(s);G.value||m.warning("Real-time updates unavailable",{description:"Deletion will proceed but you may need to refresh the page to see updated status."}),S.value=!1,pe(e),C.value=null,$.value=!1,L.value=null;try{const{data:t}=await N.delete(D(`/sites/${e}`));t.success?(fe(e),await k(!0)):Y(e,t.error||"Failed to delete site")}catch(t){console.error("Failed to delete site:",t),Y(e,"An error occurred while deleting the site")}}const A=u(null);async function ke(s){A.value=s.name;const e=F(s.name);try{const{data:t}=await N.post(D(`/sites/${e}/rebuild`),{});t.success?(m.success("Site Rebuilt",{description:`"${s.name}" has been rebuilt successfully.`}),await k(!0)):T(t.error,"rebuild site")}catch{}finally{A.value=null}}return R(de,()=>{for(const[s,e]of U.value)if(e.status==="ready"){m.success("Site Created",{description:`"${s}" has been created successfully.`});break}setTimeout(()=>{k(!0)},500)}),R(ce,()=>{for(const[s,e]of q.value)if(e.status==="deleted"){m.success("Site Deleted",{description:`"${s}" has been removed.`});break}setTimeout(()=>{k(!0)},500)}),R(()=>[...U.value.values()],(s,e)=>{for(const t of s){const d=e?.find(E=>E.slug===t.slug);t.status==="failed"&&d?.status!=="failed"&&m.error(`Failed to create site "${t.slug}"`,{description:t.error||"Unknown error occurred"})}},{deep:!0}),R(()=>[...q.value.values()],(s,e)=>{for(const t of s){const d=e?.find(E=>E.slug===t.slug);t.status==="delete_failed"&&d?.status!=="delete_failed"&&m.error(`Failed to delete site "${t.slug}"`,{description:t.error||"Unknown error occurred"})}},{deep:!0}),ze(()=>{J.value&&ue(J.value),k()}),(s,e)=>(n(),l(H,null,[o(a(Se),{title:`Sites - ${z.environment.name}`},null,8,["title"]),i("div",null,[i("header",Ee,[i("div",null,[e[2]||(e[2]=i("h1",{class:"text-2xl font-semibold tracking-tight text-zinc-100"},"Sites",-1)),i("p",Me,"Sites in "+c(z.environment.name),1)]),i("div",Be,[o(a(h),{"as-child":"",size:"sm",class:"bg-lime-500 hover:bg-lime-600 text-zinc-950"},{default:p(()=>[o(a(Ce),{href:`/environments/${z.environment.id}/sites/create`},{default:p(()=>[o(a($e),{class:"w-4 h-4 mr-1.5"}),e[3]||(e[3]=x(" New Site ",-1))]),_:1},8,["href"])]),_:1})])]),a(W)||!a(Q)?(n(),l("div",Oe,[o(a(se),{class:"w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5"}),i("div",null,[e[4]||(e[4]=i("p",{class:"text-amber-400 font-medium text-sm"},"Real-time updates unavailable",-1)),i("p",je,[a(Q)?(n(),l("span",Ge," Could not connect to WebSocket: "+c(a(W))+". Status updates for provisioning and deletion will not appear automatically. ",1)):(n(),l("span",qe," Reverb is not configured for this environment. Status updates for provisioning and deletion will not appear automatically. "))])])])):y("",!0),V.value?(n(),l("div",We,[o(a(w),{class:"w-8 h-8 mx-auto text-zinc-600 animate-spin mb-3"}),e[5]||(e[5]=i("p",{class:"text-zinc-500"},"Loading sites...",-1))])):j.value.length===0?(n(),l("div",Qe,[o(a(M),{class:"w-12 h-12 mx-auto text-zinc-600 mb-3"}),e[6]||(e[6]=i("h3",{class:"text-lg font-medium text-zinc-100 mb-2"},"No sites found",-1)),e[7]||(e[7]=i("p",{class:"text-zinc-400"},"Add site directories in the environment configuration.",-1))])):(n(),l("div",Xe,[e[10]||(e[10]=De('<div class="grid grid-cols-[1fr_100px_140px_160px] items-center gap-4 px-4 py-3 border-b border-zinc-800 bg-zinc-800/30"><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">Site</span><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">Status</span><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">PHP</span><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide text-right">Actions</span></div>',1)),i("div",null,[(n(!0),l(H,null,te(j.value,t=>(n(),l("div",{key:t.name,class:Le(["grid grid-cols-[1fr_100px_140px_160px] items-center gap-4 px-4 py-3 border-b border-zinc-800/50 last:border-b-0 transition-colors hover:bg-zinc-800/30",{"opacity-50":g(t.name),"bg-zinc-800/20":b(t),"bg-lime-500/5":v(t.name)==="deleted","bg-red-500/5":g(t.name)&&v(t.name)!=="deleted"}])},[i("div",Ye,[v(t.name)==="deleted"?(n(),r(a(Ae),{key:0,class:"w-4 h-4 shrink-0 text-lime-400"})):g(t.name)?(n(),r(a(w),{key:1,class:"w-4 h-4 shrink-0 text-red-400 animate-spin"})):b(t)?(n(),r(a(w),{key:2,class:"w-4 h-4 shrink-0 text-amber-400 animate-spin"})):_(t)==="queued"?(n(),r(a(Te),{key:3,class:"w-4 h-4 shrink-0 text-blue-400"})):_(t)==="failed"||v(t.name)==="delete_failed"?(n(),r(a(se),{key:4,class:"w-4 h-4 shrink-0 text-red-400"})):t.site_type==="laravel-package"?(n(),r(a(Ve),{key:5,class:"w-4 h-4 shrink-0 text-purple-400"})):t.site_type==="cli"?(n(),r(a(Re),{key:6,class:"w-4 h-4 shrink-0 text-amber-400"})):t.has_public_folder?(n(),r(a(ne),{key:7,class:"w-4 h-4 shrink-0 text-lime-400"})):(n(),r(a(M),{key:8,class:"w-4 h-4 shrink-0 text-zinc-500"})),i("div",Je,[i("p",Ke,c(t.display_name||t.name),1),t.github_repo&&!b(t)&&!g(t.name)?(n(),l("p",Ze,c(t.github_repo),1)):y("",!0)])]),i("div",et,[v(t.name)==="deleted"?(n(),l("span",tt," Deleted ")):v(t.name)==="delete_failed"?(n(),l("span",st," Failed ")):g(t.name)?(n(),l("span",nt,c(ge[v(t.name)]),1)):_(t)==="failed"?(n(),l("span",it," Failed ")):_(t)?(n(),l("span",at,c(K[_(t)]),1)):(n(),l("span",lt,"â€”"))]),i("div",null,[b(t)||g(t.name)?(n(),l("div",ot,c(t.php_version||P.value),1)):I.value===t.name?(n(),l("div",rt,[o(a(w),{class:"w-4 h-4 text-zinc-400 animate-spin"}),e[8]||(e[8]=i("span",{class:"text-sm text-zinc-500"},"...",-1))])):(n(),l("select",{key:2,value:t.php_version||P.value,onChange:d=>he(t,d.target.value),class:"h-8 w-[110px] text-xs py-1 pl-2 pr-7 font-mono bg-zinc-800/50 border border-zinc-700 rounded-md text-zinc-100 hover:bg-zinc-800",disabled:!t.has_public_folder},[(n(!0),l(H,null,te(O.value,d=>(n(),l("option",{key:d,value:d}," PHP "+c(d),9,ct))),128))],40,dt))]),i("div",ut,[v(t.name)==="deleted"?(n(),l("div",mt," Deleted ")):g(t.name)?(n(),l("div",pt," Deleting... ")):b(t)?(n(),l("div",ft,c(K[_(t)??"queued"]),1)):(n(),l(H,{key:3},[t.has_public_folder&&t.domain?(n(),r(a(h),{key:0,onClick:d=>ve(t.domain),variant:"outline",size:"sm",class:"h-8 px-3 bg-transparent border-zinc-700 text-zinc-300 hover:bg-zinc-800"},{default:p(()=>[o(a(He),{class:"w-3.5 h-3.5 mr-1.5"}),e[9]||(e[9]=x(" Open ",-1))]),_:1},8,["onClick"])):y("",!0),i("div",gt,[s.$page.props.multi_environment?(n(),r(a(h),{key:0,onClick:d=>xe(t.path),variant:"ghost",size:"icon-sm",class:"h-8 w-8 text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800",title:`Open in ${z.editor.name}`},{default:p(()=>[o(a(Ie),{class:"w-3.5 h-3.5"})]),_:1},8,["onClick","title"])):y("",!0),t.has_public_folder&&!b(t)&&!g(t.name)?(n(),r(a(h),{key:1,onClick:d=>ke(t),variant:"ghost",size:"icon-sm",class:"h-8 w-8 text-zinc-400 hover:text-amber-400 hover:bg-zinc-800",disabled:A.value===t.name,title:"Rebuild site"},{default:p(()=>[A.value===t.name?(n(),r(a(w),{key:0,class:"w-3.5 h-3.5 animate-spin"})):(n(),r(a(Ue),{key:1,class:"w-3.5 h-3.5"}))]),_:2},1032,["onClick","disabled"])):y("",!0),o(a(h),{onClick:d=>be(t),variant:"ghost",size:"icon-sm",class:"h-8 w-8 text-zinc-400 hover:text-red-400 hover:bg-red-500/10",title:"Delete site"},{default:p(()=>[o(a(ie),{class:"w-3.5 h-3.5"})]),_:1},8,["onClick"])])],64))])],2))),128))])])),i("div",vt,[i("div",xt,[i("div",ht,[o(a(ne),{class:"h-3.5 w-3.5 text-lime-400"}),e[11]||(e[11]=i("span",null,"Has public folder",-1))]),i("div",bt,[o(a(M),{class:"h-3.5 w-3.5"}),e[12]||(e[12]=i("span",null,"No public folder",-1))])]),i("div",_t,[a(G)?(n(),l("span",kt,[...e[13]||(e[13]=[i("span",{class:"w-2 h-2 rounded-full bg-lime-400"},null,-1),x(" Live updates ",-1)])])):(n(),l("span",yt,[...e[14]||(e[14]=[i("span",{class:"w-2 h-2 rounded-full bg-amber-400"},null,-1),x(" No live updates ",-1)])]))])]),o(Ne,{show:S.value,title:"Delete Site",onClose:e[1]||(e[1]=t=>S.value=!1)},{default:p(()=>[i("div",wt,[i("p",zt,[e[15]||(e[15]=x(" Are you sure you want to delete ",-1)),i("strong",St,c(C.value?.name),1),e[16]||(e[16]=x("? ",-1))]),e[18]||(e[18]=i("p",{class:"text-zinc-400 text-sm mb-4"},"This will:",-1)),e[19]||(e[19]=i("ul",{class:"text-zinc-400 text-sm mb-6 list-disc list-inside space-y-1"},[i("li",null,"Remove the site directory from the server")],-1)),e[20]||(e[20]=i("p",{class:"text-red-400 text-sm mb-6"},"This action cannot be undone.",-1)),L.value?(n(),l("div",Ct,[i("p",$t,c(L.value),1)])):y("",!0),i("div",Dt,[o(a(h),{onClick:e[0]||(e[0]=t=>S.value=!1),variant:"outline",disabled:$.value},{default:p(()=>[...e[17]||(e[17]=[x(" Cancel ",-1)])]),_:1},8,["disabled"]),o(a(h),{onClick:_e,variant:"destructive",disabled:$.value},{default:p(()=>[$.value?(n(),r(a(w),{key:0,class:"w-4 h-4 animate-spin"})):(n(),r(a(ie),{key:1,class:"w-4 h-4"})),x(" "+c($.value?"Deleting...":"Delete Site"),1)]),_:1},8,["disabled"])])])]),_:1},8,["show"])])],64))}});export{Et as default};
