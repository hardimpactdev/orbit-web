import{d as F,k as H,s as w,r as k,x as A,c as r,g as i,a as s,u as t,h as R,w as c,b as m,C as D,l as N,p as j,f as u,t as d,e as v,o,S as L,m as q,v as M,F as S,i as E,y as X,q as Y}from"./app-D9UrdW7P.js";import{_ as W}from"./Heading.vue_vue_type_script_setup_true_lang-DlmZui2S.js";import{X as _,Y as C,I as g}from"./craft-ui-D2B3OI3e.js";import{L as K}from"./loader-circle-9LaEdU33.js";import{C as I}from"./circle-check-big-DnNN0slO.js";import{C as $}from"./circle-alert-Bzb1T0oO.js";const J={class:"mb-6"},G={class:"space-y-6"},Q={key:0,class:"mt-2 text-sm text-red-400"},Z={key:0,class:"mt-2 text-sm text-red-400"},ee={key:0,class:"mt-2 text-sm text-red-400"},te={key:0},se={key:1,class:"p-4 bg-lime-400/10 border border-lime-400/20 rounded-lg"},le={class:"flex items-start"},oe={class:"flex-1"},re={class:"mt-1 text-sm text-zinc-400"},ne={key:0},ae={key:2,class:"p-4 bg-blue-400/10 border border-blue-400/20 rounded-lg"},ie={class:"flex items-start"},ue={class:"flex-1"},de={class:"text-sm font-medium text-blue-400"},me={key:3,class:"p-4 bg-red-400/10 border border-red-400/20 rounded-lg"},ce={class:"flex items-start"},pe={class:"flex-1"},ve={class:"mt-1 text-sm text-zinc-400"},he={key:4},fe={key:0,label:"Saved Keys"},ye=["value"],be={key:1,label:"Import from ~/.ssh/"},xe=["value"],ke={key:2,class:"mt-2 text-sm text-red-400"},_e={key:0,class:"mt-8 p-4 bg-yellow-400/10 border border-yellow-400/20 rounded-lg"},ge={class:"mt-8 flex gap-3"},Oe=F({__name:"Create",props:{sshKeys:{},availableSshKeys:{}},setup(h){const b=h,V=w(()=>b.sshKeys.find(e=>e.is_default)?.public_key||b.sshKeys[0]?.public_key||""),l=H({name:"",host:"",user:"root",ssh_public_key:V.value}),z=w(()=>b.sshKeys.length>0||Object.keys(b.availableSshKeys).length>0),x=k(V.value),P=w(()=>!z.value||x.value==="custom");A(x,p=>{p&&p!=="custom"?l.ssh_public_key=p:p==="custom"&&(l.ssh_public_key="")});const f=k(!1),a=k(null),y=k(!1);A([()=>l.host,()=>l.user],()=>{a.value=null,y.value=!1});const T=async()=>{if(l.host){f.value=!0,a.value=null;try{const p=await fetch("/provision/check-server",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")||""},body:JSON.stringify({host:l.host,user:l.user})});a.value=await p.json(),y.value=!0}catch{a.value={has_orbit:!1,has_orbit_user:!1,orbit_running:!1,can_connect:!1,connected_as:null,error:"Failed to check server connection"},y.value=!0}finally{f.value=!1}}},U=()=>{Y.post("/servers",{name:l.name,host:l.host,user:a.value?.connected_as==="launchpad"?"launchpad":l.user,port:22,is_local:!1})},B=()=>{l.post("/provision")};return(p,e)=>(o(),r(S,null,[i(t(R),{title:"Add Remote Environment"}),s("div",null,[s("div",J,[i(t(N),{href:"/servers",class:"text-zinc-400 hover:text-white flex items-center transition-colors text-sm"},{default:c(()=>[i(t(D),{class:"w-4 h-4 mr-1"}),e[6]||(e[6]=m(" Back to Environments ",-1))]),_:1})]),i(W,{title:"Add Remote Environment"}),e[22]||(e[22]=s("p",{class:"text-zinc-400 mb-8 mt-2"}," Set up a remote environment with the complete Orbit stack. Requires root SSH access. ",-1)),s("form",{onSubmit:j(B,["prevent"]),class:"max-w-lg"},[s("div",G,[s("div",null,[i(t(_),{for:"name",class:"text-muted-foreground mb-2"},{default:c(()=>[...e[7]||(e[7]=[m(" Environment Name ",-1)])]),_:1}),i(t(C),{modelValue:t(l).name,"onUpdate:modelValue":e[0]||(e[0]=n=>t(l).name=n),type:"text",id:"name",required:"",placeholder:"Production",class:"w-full"},null,8,["modelValue"]),t(l).errors.name?(o(),r("p",Q,d(t(l).errors.name),1)):u("",!0)]),s("div",null,[i(t(_),{for:"host",class:"text-muted-foreground mb-2"},{default:c(()=>[...e[8]||(e[8]=[m(" Host IP Address ",-1)])]),_:1}),i(t(C),{modelValue:t(l).host,"onUpdate:modelValue":e[1]||(e[1]=n=>t(l).host=n),type:"text",id:"host",required:"",placeholder:"192.168.1.100",class:"w-full"},null,8,["modelValue"]),t(l).errors.host?(o(),r("p",Z,d(t(l).errors.host),1)):u("",!0)]),s("div",null,[i(t(_),{for:"user",class:"text-muted-foreground mb-2"},{default:c(()=>[...e[9]||(e[9]=[m(" SSH User ",-1)])]),_:1}),i(t(C),{modelValue:t(l).user,"onUpdate:modelValue":e[2]||(e[2]=n=>t(l).user=n),type:"text",id:"user",required:"",placeholder:"root",class:"w-full"},null,8,["modelValue"]),e[10]||(e[10]=s("p",{class:"mt-2 text-sm text-muted-foreground"}," User must have sudo privileges for provisioning ",-1)),t(l).errors.user?(o(),r("p",ee,d(t(l).errors.user),1)):u("",!0)]),t(l).host&&!y.value?(o(),r("div",te,[i(t(g),{type:"button",onClick:T,disabled:f.value,variant:"outline",class:"w-full"},{default:c(()=>[f.value?(o(),v(t(K),{key:0,class:"w-4 h-4 animate-spin"})):(o(),v(t(L),{key:1,class:"w-4 h-4"})),m(" "+d(f.value?"Checking server...":"Check Server"),1)]),_:1},8,["disabled"])])):u("",!0),a.value?.has_orbit?(o(),r("div",se,[s("div",le,[i(t(I),{class:"w-5 h-5 text-lime-400 mr-3 mt-0.5 flex-shrink-0"}),s("div",oe,[e[11]||(e[11]=s("p",{class:"text-sm font-medium text-lime-400"}," Orbit is already configured on this server! ",-1)),s("p",re,[m(" Status: "+d(a.value.orbit_running?"Running":"Not running")+" ",1),a.value.status?.sites?.length?(o(),r("span",ne," · "+d(a.value.status.sites.length)+" site(s)",1)):u("",!0)]),e[12]||(e[12]=s("p",{class:"mt-2 text-sm text-zinc-500"}," You can add this environment without re-provisioning. ",-1))])])])):a.value?.can_connect&&!a.value?.has_orbit?(o(),r("div",ae,[s("div",ie,[i(t(I),{class:"w-5 h-5 text-blue-400 mr-3 mt-0.5 flex-shrink-0"}),s("div",ue,[s("p",de," Connected successfully as "+d(a.value.connected_as),1),e[13]||(e[13]=s("p",{class:"mt-1 text-sm text-zinc-400"}," Orbit is not installed on this server. Provisioning will set it up. ",-1))])])])):a.value?.error?(o(),r("div",me,[s("div",ce,[i(t($),{class:"w-5 h-5 text-red-400 mr-3 mt-0.5 flex-shrink-0"}),s("div",pe,[e[14]||(e[14]=s("p",{class:"text-sm font-medium text-red-400"},"Connection Failed",-1)),s("p",ve,d(a.value.error),1),s("button",{type:"button",onClick:e[3]||(e[3]=n=>y.value=!1),class:"mt-2 text-sm text-zinc-400 hover:text-white transition-colors"}," Try again ")])])])):u("",!0),a.value?.has_orbit?u("",!0):(o(),r("div",he,[i(t(_),{for:"ssh_public_key",class:"text-muted-foreground mb-2"},{default:c(()=>[...e[15]||(e[15]=[m(" SSH Public Key ",-1)])]),_:1}),z.value?q((o(),r("select",{key:0,"onUpdate:modelValue":e[4]||(e[4]=n=>x.value=n),class:"w-full"},[e[16]||(e[16]=s("option",{value:""},"Select a key...",-1)),h.sshKeys.length>0?(o(),r("optgroup",fe,[(o(!0),r(S,null,E(h.sshKeys,n=>(o(),r("option",{key:n.id,value:n.public_key},d(n.name)+" ("+d(n.key_type)+")"+d(n.is_default?" ★":""),9,ye))),128))])):u("",!0),Object.keys(h.availableSshKeys).length>0?(o(),r("optgroup",be,[(o(!0),r(S,null,E(h.availableSshKeys,(n,O)=>(o(),r("option",{key:O,value:n.content},d(O)+" ("+d(n.type)+") ",9,xe))),128))])):u("",!0),e[17]||(e[17]=s("option",{value:"custom"},"Enter custom key...",-1))],512)),[[M,x.value]]):u("",!0),P.value?q((o(),r("textarea",{key:1,"onUpdate:modelValue":e[5]||(e[5]=n=>t(l).ssh_public_key=n),id:"ssh_public_key",rows:"3",required:"",placeholder:"ssh-rsa AAAA...",class:"w-full mt-2 font-mono text-sm"},null,512)),[[X,t(l).ssh_public_key]]):u("",!0),e[18]||(e[18]=s("p",{class:"mt-2 text-sm text-muted-foreground"}," This key will be added to the launchpad user on the remote machine ",-1)),t(l).errors.ssh_public_key?(o(),r("p",ke,d(t(l).errors.ssh_public_key),1)):u("",!0)]))]),a.value?.has_orbit?u("",!0):(o(),r("div",_e,[...e[19]||(e[19]=[s("p",{class:"text-sm text-yellow-400"},[s("strong",null,"Note:"),m(" We'll first check if Orbit is already installed. If not, provisioning will make these changes: ")],-1),s("ul",{class:"mt-2 text-sm text-zinc-400 list-disc list-inside space-y-1"},[s("li",null,[m(" Create a "),s("code",{class:"bg-zinc-800 px-1 rounded text-zinc-300"},"launchpad"),m(" user with sudo access ")]),s("li",null,"Disable SSH password authentication"),s("li",null,"Disable root SSH login"),s("li",null,"Install Docker"),s("li",null,"Install and initialize Orbit")],-1)])])),s("div",ge,[a.value?.has_orbit?(o(),v(t(g),{key:0,type:"button",onClick:U,disabled:t(l).processing||!t(l).name,variant:"secondary"},{default:c(()=>[t(l).processing?(o(),v(t(K),{key:0,class:"w-4 h-4 animate-spin"})):u("",!0),e[20]||(e[20]=m(" Add ",-1))]),_:1},8,["disabled"])):(o(),v(t(g),{key:1,type:"submit",disabled:t(l).processing,variant:"secondary"},{default:c(()=>[t(l).processing?(o(),v(t(K),{key:0,class:"w-4 h-4 animate-spin"})):u("",!0),m(" "+d(t(l).processing?"Setting up...":"Provision"),1)]),_:1},8,["disabled"])),i(t(g),{"as-child":"",variant:"ghost"},{default:c(()=>[i(t(N),{href:"/servers"},{default:c(()=>[...e[21]||(e[21]=[m("Cancel",-1)])]),_:1})]),_:1})])],32)])],64))}});export{Oe as default};
