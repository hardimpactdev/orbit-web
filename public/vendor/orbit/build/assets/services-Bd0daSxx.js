import{V as a}from"./app-G84ngf6M.js";const v=300*1e3,h=a("services",{state:()=>({environments:{},activeEnvironmentId:null}),getters:{currentEnv(){return this.activeEnvironmentId?this.environments[this.activeEnvironmentId]??null:null},services(){return this.currentEnv?.services??{}},pendingJobs(){return this.currentEnv?.pendingJobs??{}},servicesRunning(){return Object.values(this.services).filter(e=>e.status==="running").length},servicesTotal(){return Object.keys(this.services).length},isStale(){const e=this.currentEnv?.lastUpdated;return e?Date.now()-e>v:!0},isServicePending(){return e=>Object.values(this.pendingJobs).some(t=>t.service===e)},getServiceError(){return e=>Object.values(this.pendingJobs).find(s=>s.service===e&&s.error)?.error}},actions:{setActiveEnvironment(e){this.activeEnvironmentId=e,this.environments[e]||(this.environments[e]={services:{},pendingJobs:{},lastUpdated:null})},async refreshIfStale(e){this.isStale&&await this.fetchServices(e)},async fetchServices(e){try{const t=await fetch(`${e}/status`);if(!t.ok){console.error("Failed to fetch services:",t.status,t.statusText);return}const s=await t.json();s.success&&s.data?.services?this.updateServices(s.data.services):s.services?this.updateServices(s.services):s.data?.services&&this.updateServices(s.data.services)}catch(t){console.error("Failed to fetch services:",t)}},updateServices(e){if(!this.activeEnvironmentId)return;const t=this.environments[this.activeEnvironmentId];t&&(t.services=e,t.lastUpdated=Date.now())},async startService(e,t,s="docker"){return this.dispatchServiceAction(e,"start",t,s)},async stopService(e,t,s="docker"){return this.dispatchServiceAction(e,"stop",t,s)},async restartService(e,t,s="docker"){return this.dispatchServiceAction(e,"restart",t,s)},async startAll(e){return this.dispatchGlobalAction("start",e)},async stopAll(e){return this.dispatchGlobalAction("stop",e)},async restartAll(e){return this.dispatchGlobalAction("restart",e)},async enableService(e,t){return this.dispatchServiceAction(e,"enable",t)},async disableService(e,t){return this.dispatchServiceAction(e,"disable",t)},async dispatchGlobalAction(e,t){try{return await(await fetch(`${t}/${e}`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""}})).json()}catch(s){throw console.error(`Failed to ${e} all services:`,s),s}},async dispatchServiceAction(e,t,s,r="docker"){if(this.activeEnvironmentId)try{const i=await(await fetch(`${s}/${r==="host"?"host-services":"services"}/${e}/${t}`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.content||""}})).json();if(i.jobId){const o=this.environments[this.activeEnvironmentId];o&&(o.pendingJobs[i.jobId]={service:e,action:t,startedAt:Date.now()})}return i}catch(n){throw console.error(`Failed to ${t} service ${e}:`,n),n}},handleServiceStatusChanged(e,t,s,r){if(!this.activeEnvironmentId)return;const n=this.environments[this.activeEnvironmentId];n&&(e&&n.pendingJobs[e]&&(r?n.pendingJobs[e].error=r:delete n.pendingJobs[e]),n.services[t]&&(n.services[t].status=s),n.lastUpdated=Date.now())},clearPendingJobError(e){if(!this.activeEnvironmentId)return;const t=this.environments[this.activeEnvironmentId];t?.pendingJobs[e]&&delete t.pendingJobs[e]},clearServiceError(e){if(!this.activeEnvironmentId)return;const t=this.environments[this.activeEnvironmentId];if(!t)return;Object.entries(t.pendingJobs).filter(([r,n])=>n.service===e&&n.error).map(([r])=>r).forEach(r=>{delete t.pendingJobs[r]})},async recoverPendingJobs(e){if(!this.activeEnvironmentId)return;const t=this.environments[this.activeEnvironmentId];if(!t)return;const s=300*1e3;for(const[r,n]of Object.entries(t.pendingJobs)){if(Date.now()-n.startedAt>s){delete t.pendingJobs[r];continue}try{const i=await(await fetch(`${e}/jobs/${r}`)).json();(i.status==="completed"||i.status==="failed")&&(i.status==="failed"?t.pendingJobs[r].error=i.error:delete t.pendingJobs[r])}catch{delete t.pendingJobs[r]}}}},persist:{key:"orbit-services",pick:["environments"]}});export{h as u};
