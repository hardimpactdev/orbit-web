import{c as B,d as we,V as ze,m as R,M as f,z as Se,x as se,a as l,h as r,b as a,u as i,i as Ce,g as w,t as c,w as m,l as $e,e as g,P as De,r as u,W as Pe,F as U,j as ne,o as n,f as d,O as Fe,T as Ve,n as Ae,I as Le,X as Re,E as Ue}from"./app-Bbna9dak.js";import{a as N}from"./axios-BgMvqVbd.js";import{_ as Ne}from"./Modal.vue_vue_type_script_setup_true_lang-C8amXFRF.js";import{I as h,g as Ie,X as He}from"./craft-ui-C92f09yC.js";import{C as ae}from"./circle-alert-CI0a99a-.js";import{L as z}from"./loader-circle-BXJ5bexd.js";import{G as ie}from"./globe-Bj0vX_Lm.js";import{T as le}from"./trash-2-DaZ2o4F1.js";import{P as Te}from"./package-Do3oQPF8.js";import{R as je}from"./refresh-cw-cxm87Xui.js";const Ee=B("clock-3",[["path",{d:"M12 6v6h4",key:"135r8i"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);const Me=B("code",[["path",{d:"m16 18 6-6-6-6",key:"eg8j8"}],["path",{d:"m8 6-6 6 6 6",key:"ppft3o"}]]);const M=B("folder-open",[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]]),Be={class:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-8"},Oe={class:"text-sm text-zinc-500 mt-1"},qe={class:"flex items-center gap-2"},Xe={key:0,class:"mb-6 p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg flex items-start gap-3"},Ge={class:"text-zinc-400 text-sm mt-1"},We={key:0},Qe={key:1},Ye={key:1,class:"rounded-lg border border-zinc-800 bg-zinc-900/50 p-8 text-center"},Je={key:2,class:"rounded-lg border border-zinc-800 bg-zinc-900/50 p-8 text-center"},Ke={key:3,class:"rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden"},Ze={class:"flex items-center gap-3 min-w-0"},et={class:"min-w-0"},tt={class:"font-medium text-sm text-zinc-100 truncate"},st={key:0,class:"text-xs text-zinc-500 truncate"},nt={class:"text-sm"},at={key:0,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-lime-500/15 text-lime-400"},it={key:1,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-500/15 text-red-400"},lt={key:2,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-500/15 text-red-400"},ot={key:3,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-500/15 text-red-400"},rt={key:4,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-amber-500/15 text-amber-400"},dt={key:5,class:"text-zinc-500/50"},ct={key:0,class:"text-sm text-zinc-500 font-mono"},ut={key:1,class:"flex items-center gap-2"},mt=["value","onChange","disabled"],pt=["value"],ft={class:"flex items-center justify-end gap-1"},gt={key:0,class:"text-xs text-lime-400"},vt={key:1,class:"text-xs text-red-400"},xt={key:2,class:"text-xs text-zinc-500"},ht={class:"flex items-center gap-0.5 opacity-60 hover:opacity-100 transition-opacity"},bt={class:"flex items-center justify-between mt-4 px-1"},kt={class:"flex items-center gap-4 text-xs text-zinc-500"},_t={class:"flex items-center gap-1.5"},yt={class:"flex items-center gap-1.5"},wt={class:"flex items-center gap-1.5 text-xs"},zt={key:0,class:"inline-flex items-center gap-1.5 text-lime-400"},St={key:1,class:"inline-flex items-center gap-1.5 text-amber-400"},Ct={class:"p-6"},$t={class:"text-zinc-300 mb-4"},Dt={class:"text-white"},Pt={class:"flex items-center gap-3 mb-6"},Ft={key:0,class:"mb-4 p-3 bg-red-400/10 border border-red-400/20 rounded-lg"},Vt={class:"text-red-400 text-sm"},At={class:"flex justify-end gap-3"},Bt=we({__name:"Sites",props:{environment:{},editor:{},remoteApiUrl:{}},setup(S){const p=S,I=s=>p.remoteApiUrl?`${p.remoteApiUrl}${s}`:`/api/environments/${p.environment.id}${s}`,oe=Fe(),O=u([]),re=["queued","creating_repo","cloning","setting_up","installing_composer","installing_npm","building","finalizing"],H=u(!0),de=u("test"),P=u("8.4"),q=u(["8.3","8.4","8.5"]),T=u(null),X=se(()=>{const s=new Map(O.value.map(e=>[e.name,e]));for(const[e,t]of j.value)s.has(e)||s.set(e,{id:0,name:e,path:`~/sites/${e}`,has_public_folder:!1,php_version:P.value,status:t.status});return Array.from(s.values()).sort((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))}),{provisioningSites:j,deletingSites:G,isConnected:W,connectionError:Q,siteReadyCount:ce,siteDeletedCount:ue,isConfigured:Y,trackSite:me,getSiteStatus:pe,trackDeletion:fe,getDeletionStatus:J,markDeletionComplete:ge,markDeletionFailed:K}=ze(),Z=se(()=>{const s=oe.props.flash;return s?.provisioning?s.provisioning:new URLSearchParams(window.location.search).get("provisioning")}),ee={queued:"Queued...",provisioning:"Initializing...",validating_package:"Validating package...",creating_project:"Creating project...",forking:"Forking repository...",creating_repo:"Creating repository...",cloning:"Cloning...",setting_up:"Setting up...",installing_composer:"Installing Composer...",installing_npm:"Installing dependencies...",building:"Building assets...",finalizing:"Finalizing...",ready:"Ready",failed:"Failed"},ve={deleting:"Deleting...",removing_files:"Removing files...",deleted:"Deleted",delete_failed:"Delete failed"};function F(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")}function v(s){const e=F(s),t=J(e);return t?t.status!=="delete_failed":!1}function x(s){const e=F(s);return J(e)?.status??null}function te(s){const e=s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,""),t=pe(e);return t||(s.status&&re.includes(s.status)?{slug:s.name,status:s.status,error:s.error_message??null,siteId:s.id}:null)}function b(s){const e=te(s);return e?e.status!=="ready"&&e.status!=="failed":!1}function k(s){const e=te(s);return e?.status==="ready"?null:e?.status??null}function E(s,e){const t=s||"Unknown error";if(t.includes("Connection error"))f.error("Connection Error",{description:"Could not connect to the environment. Check if Orbit is running."});else{const o=e.charAt(0).toUpperCase()+e.slice(1)+" Failed";f.error(o,{description:t})}}async function _(s=!1){s||(H.value=!0);try{const{data:e}=await N.get(I("/sites"));e.success&&e.data?(O.value=e.data.sites||[],de.value=e.data.tld||"test",P.value=e.data.default_php_version||"8.4",e.data.available_php_versions?.length&&(q.value=e.data.available_php_versions)):!e.success&&!s&&E(e.error,"load sites")}catch(e){if(Ve.isCancel(e))return;console.error("Failed to load sites:",e)}finally{s||(H.value=!1)}}function xe(s){const e=`https://${s}`;window.open(e,"_blank")}function he(s){let e;if(p.environment.is_local)e=`${p.editor.scheme}://file${s}`;else{const t=`${p.environment.user}@${p.environment.host}`;e=`${p.editor.scheme}://vscode-remote/ssh-remote+${t}${s}?windowId=_blank`}window.open(e,"_blank")}async function be(s,e){if(s.domain){T.value=s.name;try{const t=encodeURIComponent(s.name),{data:o}=await N.post(`/sites/${t}/php`,{version:e});o.success?(f.success("PHP Version Changed",{description:`Now using PHP ${e} for this site.`}),await _(!0)):E(o.error,"change PHP version")}catch{}finally{T.value=null}}}const C=u(!1),$=u(null),D=u(!1),V=u(null),A=u(!0);function ke(s){$.value=s,V.value=null,A.value=!0,C.value=!0}async function _e(){if(!$.value)return;const s=$.value.name,e=F(s);W.value||f.warning("Real-time updates unavailable",{description:"Deletion will proceed but you may need to refresh the page to see updated status."}),C.value=!1,fe(e),$.value=null,D.value=!1,V.value=null;const t=!A.value;try{const o=p.remoteApiUrl?`/sites/${e}`:I(`/sites/${e}`),{data:y}=await N.delete(o,{params:{keep_db:t?"1":"0"}});y.success?(ge(e),await _(!0)):K(e,y.error||"Failed to delete site")}catch(o){console.error("Failed to delete site:",o),K(e,"An error occurred while deleting the site")}}const L=u(null);async function ye(s){L.value=s.name;const e=F(s.name);try{const{data:t}=await N.post(I(`/sites/${e}/rebuild`),{});t.success?(f.success("Site Rebuilt",{description:`"${s.name}" has been rebuilt successfully.`}),await _(!0)):E(t.error,"rebuild site")}catch{}finally{L.value=null}}return R(ce,()=>{for(const[s,e]of j.value)if(e.status==="ready"){f.success("Site Created",{description:`"${s}" has been created successfully.`});break}setTimeout(()=>{_(!0)},500)}),R(ue,()=>{for(const[s,e]of G.value)if(e.status==="deleted"){f.success("Site Deleted",{description:`"${s}" has been removed.`});break}setTimeout(()=>{_(!0)},500)}),R(()=>[...j.value.values()],(s,e)=>{for(const t of s){const o=e?.find(y=>y.slug===t.slug);t.status==="failed"&&o?.status!=="failed"&&f.error(`Failed to create site "${t.slug}"`,{description:t.error||"Unknown error occurred"})}},{deep:!0}),R(()=>[...G.value.values()],(s,e)=>{for(const t of s){const o=e?.find(y=>y.slug===t.slug);t.status==="delete_failed"&&o?.status!=="delete_failed"&&f.error(`Failed to delete site "${t.slug}"`,{description:t.error||"Unknown error occurred"})}},{deep:!0}),Se(()=>{Z.value&&me(Z.value),_()}),(s,e)=>(n(),l(U,null,[r(i(Ce),{title:`Sites - ${S.environment.name}`},null,8,["title"]),a("div",null,[a("header",Be,[a("div",null,[e[3]||(e[3]=a("h1",{class:"text-2xl font-semibold tracking-tight text-zinc-100"},"Sites",-1)),a("p",Oe,"Sites in "+c(S.environment.name),1)]),a("div",qe,[r(i(h),{"as-child":"",size:"sm",class:"bg-lime-500 hover:bg-lime-600 text-zinc-950"},{default:m(()=>[r(i($e),{href:`/environments/${S.environment.id}/sites/create`},{default:m(()=>[r(i(De),{class:"w-4 h-4 mr-1.5"}),e[4]||(e[4]=g(" New Site ",-1))]),_:1},8,["href"])]),_:1})])]),i(Q)||!i(Y)?(n(),l("div",Xe,[r(i(ae),{class:"w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5"}),a("div",null,[e[5]||(e[5]=a("p",{class:"text-amber-400 font-medium text-sm"},"Real-time updates unavailable",-1)),a("p",Ge,[i(Y)?(n(),l("span",Qe," Could not connect to WebSocket: "+c(i(Q))+". Status updates for provisioning and deletion will not appear automatically. ",1)):(n(),l("span",We," Reverb is not configured for this environment. Status updates for provisioning and deletion will not appear automatically. "))])])])):w("",!0),H.value?(n(),l("div",Ye,[r(i(z),{class:"w-8 h-8 mx-auto text-zinc-600 animate-spin mb-3"}),e[6]||(e[6]=a("p",{class:"text-zinc-500"},"Loading sites...",-1))])):X.value.length===0?(n(),l("div",Je,[r(i(M),{class:"w-12 h-12 mx-auto text-zinc-600 mb-3"}),e[7]||(e[7]=a("h3",{class:"text-lg font-medium text-zinc-100 mb-2"},"No sites found",-1)),e[8]||(e[8]=a("p",{class:"text-zinc-400"},"Add site directories in the environment configuration.",-1))])):(n(),l("div",Ke,[e[11]||(e[11]=Pe('<div class="grid grid-cols-[1fr_100px_140px_160px] items-center gap-4 px-4 py-3 border-b border-zinc-800 bg-zinc-800/30"><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">Site</span><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">Status</span><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">PHP</span><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide text-right">Actions</span></div>',1)),a("div",null,[(n(!0),l(U,null,ne(X.value,t=>(n(),l("div",{key:t.name,class:Ae(["grid grid-cols-[1fr_100px_140px_160px] items-center gap-4 px-4 py-3 border-b border-zinc-800/50 last:border-b-0 transition-colors hover:bg-zinc-800/30",{"opacity-50":v(t.name),"bg-zinc-800/20":b(t),"bg-lime-500/5":x(t.name)==="deleted","bg-red-500/5":v(t.name)&&x(t.name)!=="deleted"}])},[a("div",Ze,[x(t.name)==="deleted"?(n(),d(i(Le),{key:0,class:"w-4 h-4 shrink-0 text-lime-400"})):v(t.name)?(n(),d(i(z),{key:1,class:"w-4 h-4 shrink-0 text-red-400 animate-spin"})):b(t)?(n(),d(i(z),{key:2,class:"w-4 h-4 shrink-0 text-amber-400 animate-spin"})):k(t)==="queued"?(n(),d(i(Ee),{key:3,class:"w-4 h-4 shrink-0 text-blue-400"})):k(t)==="failed"||x(t.name)==="delete_failed"?(n(),d(i(ae),{key:4,class:"w-4 h-4 shrink-0 text-red-400"})):t.site_type==="laravel-package"?(n(),d(i(Te),{key:5,class:"w-4 h-4 shrink-0 text-purple-400"})):t.site_type==="cli"?(n(),d(i(Re),{key:6,class:"w-4 h-4 shrink-0 text-amber-400"})):t.has_public_folder?(n(),d(i(ie),{key:7,class:"w-4 h-4 shrink-0 text-lime-400"})):(n(),d(i(M),{key:8,class:"w-4 h-4 shrink-0 text-zinc-500"})),a("div",et,[a("p",tt,c(t.display_name||t.name),1),t.github_repo&&!b(t)&&!v(t.name)?(n(),l("p",st,c(t.github_repo),1)):w("",!0)])]),a("div",nt,[x(t.name)==="deleted"?(n(),l("span",at," Deleted ")):x(t.name)==="delete_failed"?(n(),l("span",it," Failed ")):v(t.name)?(n(),l("span",lt,c(ve[x(t.name)]),1)):k(t)==="failed"?(n(),l("span",ot," Failed ")):k(t)?(n(),l("span",rt,c(ee[k(t)]),1)):(n(),l("span",dt,"â€”"))]),a("div",null,[b(t)||v(t.name)?(n(),l("div",ct,c(t.php_version||P.value),1)):T.value===t.name?(n(),l("div",ut,[r(i(z),{class:"w-4 h-4 text-zinc-400 animate-spin"}),e[9]||(e[9]=a("span",{class:"text-sm text-zinc-500"},"...",-1))])):(n(),l("select",{key:2,value:t.php_version||P.value,onChange:o=>be(t,o.target.value),class:"h-8 w-[110px] text-xs py-1 pl-2 pr-7 font-mono bg-zinc-800/50 border border-zinc-700 rounded-md text-zinc-100 hover:bg-zinc-800",disabled:!t.has_public_folder},[(n(!0),l(U,null,ne(q.value,o=>(n(),l("option",{key:o,value:o}," PHP "+c(o),9,pt))),128))],40,mt))]),a("div",ft,[x(t.name)==="deleted"?(n(),l("div",gt," Deleted ")):v(t.name)?(n(),l("div",vt," Deleting... ")):b(t)?(n(),l("div",xt,c(ee[k(t)??"queued"]),1)):(n(),l(U,{key:3},[t.has_public_folder&&t.domain?(n(),d(i(h),{key:0,onClick:o=>xe(t.domain),variant:"outline",size:"sm",class:"h-8 px-3 bg-transparent border-zinc-700 text-zinc-300 hover:bg-zinc-800"},{default:m(()=>[r(i(Ue),{class:"w-3.5 h-3.5 mr-1.5"}),e[10]||(e[10]=g(" Open ",-1))]),_:1},8,["onClick"])):w("",!0),a("div",ht,[s.$page.props.multi_environment?(n(),d(i(h),{key:0,onClick:o=>he(t.path),variant:"ghost",size:"icon-sm",class:"h-8 w-8 text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800",title:`Open in ${S.editor.name}`},{default:m(()=>[r(i(Me),{class:"w-3.5 h-3.5"})]),_:1},8,["onClick","title"])):w("",!0),t.has_public_folder&&!b(t)&&!v(t.name)?(n(),d(i(h),{key:1,onClick:o=>ye(t),variant:"ghost",size:"icon-sm",class:"h-8 w-8 text-zinc-400 hover:text-amber-400 hover:bg-zinc-800",disabled:L.value===t.name,title:"Rebuild site"},{default:m(()=>[L.value===t.name?(n(),d(i(z),{key:0,class:"w-3.5 h-3.5 animate-spin"})):(n(),d(i(je),{key:1,class:"w-3.5 h-3.5"}))]),_:2},1032,["onClick","disabled"])):w("",!0),r(i(h),{onClick:o=>ke(t),variant:"ghost",size:"icon-sm",class:"h-8 w-8 text-zinc-400 hover:text-red-400 hover:bg-red-500/10",title:"Delete site"},{default:m(()=>[r(i(le),{class:"w-3.5 h-3.5"})]),_:1},8,["onClick"])])],64))])],2))),128))])])),a("div",bt,[a("div",kt,[a("div",_t,[r(i(ie),{class:"h-3.5 w-3.5 text-lime-400"}),e[12]||(e[12]=a("span",null,"Has public folder",-1))]),a("div",yt,[r(i(M),{class:"h-3.5 w-3.5"}),e[13]||(e[13]=a("span",null,"No public folder",-1))])]),a("div",wt,[i(W)?(n(),l("span",zt,[...e[14]||(e[14]=[a("span",{class:"w-2 h-2 rounded-full bg-lime-400"},null,-1),g(" Live updates ",-1)])])):(n(),l("span",St,[...e[15]||(e[15]=[a("span",{class:"w-2 h-2 rounded-full bg-amber-400"},null,-1),g(" No live updates ",-1)])]))])]),r(Ne,{show:C.value,title:"Delete Site",onClose:e[2]||(e[2]=t=>C.value=!1)},{default:m(()=>[a("div",Ct,[a("p",$t,[e[16]||(e[16]=g(" Are you sure you want to delete ",-1)),a("strong",Dt,c($.value?.name),1),e[17]||(e[17]=g("? ",-1))]),e[20]||(e[20]=a("p",{class:"text-zinc-400 text-sm mb-4"},"This will:",-1)),e[21]||(e[21]=a("ul",{class:"text-zinc-400 text-sm mb-4 list-disc list-inside space-y-1"},[a("li",null,"Remove the site directory from the server")],-1)),a("div",Pt,[r(i(Ie),{id:"delete-database",modelValue:A.value,"onUpdate:modelValue":e[0]||(e[0]=t=>A.value=t),class:"border-zinc-600 data-[state=checked]:bg-primary data-[state=checked]:border-primary data-[state=checked]:text-primary-foreground"},null,8,["modelValue"]),r(i(He),{for:"delete-database",class:"text-zinc-300 text-sm cursor-pointer"},{default:m(()=>[...e[18]||(e[18]=[g(" Also delete the database ",-1)])]),_:1})]),e[22]||(e[22]=a("p",{class:"text-red-400 text-sm mb-6"},"This action cannot be undone.",-1)),V.value?(n(),l("div",Ft,[a("p",Vt,c(V.value),1)])):w("",!0),a("div",At,[r(i(h),{onClick:e[1]||(e[1]=t=>C.value=!1),variant:"outline",disabled:D.value},{default:m(()=>[...e[19]||(e[19]=[g(" Cancel ",-1)])]),_:1},8,["disabled"]),r(i(h),{onClick:_e,variant:"destructive",disabled:D.value},{default:m(()=>[D.value?(n(),d(i(z),{key:0,class:"w-4 h-4 animate-spin"})):(n(),d(i(le),{key:1,class:"w-4 h-4"})),g(" "+c(D.value?"Deleting...":"Delete Site"),1)]),_:1},8,["disabled"])])])]),_:1},8,["show"])])],64))}});export{Bt as default};
