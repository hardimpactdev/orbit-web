import{j as _e,L as $e,s as E,N as G,r as p,O as xe,d as Pe,x as Q,M as x,z as Fe,c as u,g as o,a as i,u as a,h as Ae,f as C,t as v,w as r,l as Le,b as f,P as Ee,o as l,F as re,i as pe,e as d,n as Re,I as Ue,W as Ie,E as Te,U as Me}from"./app-D9UrdW7P.js";import{a as X}from"./axios-C-GjRQfx.js";import{_ as Ne}from"./Heading.vue_vue_type_script_setup_true_lang-DlmZui2S.js";import{_ as He}from"./Modal.vue_vue_type_script_setup_true_lang-3tbdUR2Y.js";import{I as z,a as Ve,q as ge,b as J,j as je,A as K,D as N,U as Be}from"./craft-ui-D2B3OI3e.js";import{C as ve}from"./circle-alert-Bzb1T0oO.js";import{L}from"./loader-circle-9LaEdU33.js";import{P as qe}from"./package-vTiRMxXL.js";import{G as be}from"./globe-B7BAe9ni.js";import{C as Ye}from"./code-DHPZAd3M.js";import{R as Oe}from"./refresh-cw-eSdnRuMR.js";import{T as he}from"./trash-2-Bgrxf0ei.js";const We=_e("clock-3",[["path",{d:"M12 6v6h4",key:"135r8i"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);const ue=_e("folder-open",[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]]);function Ge(){const g=p(new Map),c=p(new Map),w=$e(),Z=xe(),b=E(()=>!!Z.props.reverb?.enabled),ee=E(()=>b.value),D=p(0),H=p(0),$=E(()=>b.value&&w.value==="connected"),V=E(()=>b.value&&w.value==="failed"?"Reverb connection unavailable":null),S=new Map;function R(n){if(S.get(n.slug)===n.status)return;S.set(n.slug,n.status);const h=g.value.get(n.slug);g.value.set(n.slug,{slug:n.slug,status:n.status,error:n.error,siteId:n.site_id??h?.siteId}),(n.status==="ready"||n.status==="failed")&&(n.status==="ready"&&D.value++,setTimeout(()=>{g.value.delete(n.slug),S.delete(n.slug)},15e3))}b.value&&(G("provisioning",".site.provision.status",R),G("provisioning",".site.deletion.status",U));const y=new Map;function U(n){y.get(n.slug)!==n.status&&(y.set(n.slug,n.status),c.value.set(n.slug,{slug:n.slug,status:n.status,error:n.error}),(n.status==="deleted"||n.status==="delete_failed")&&(n.status==="deleted"&&H.value++,setTimeout(()=>{c.value.delete(n.slug),y.delete(n.slug)},2e3)))}function j(n){c.value.has(n)||c.value.set(n,{slug:n,status:"deleting"}),G(`site.${n}`,".site.deletion.status",h=>{b.value&&U(h)})}function B(n){return c.value.get(n)}function te(n){c.value.set(n,{slug:n,status:"deleted"}),setTimeout(()=>{c.value.delete(n)},2e3)}function se(n,h){c.value.set(n,{slug:n,status:"delete_failed",error:h})}function q(n){c.value.delete(n),y.delete(n)}function ne(n){g.value.has(n)||g.value.set(n,{slug:n,status:"provisioning"}),G(`site.${n}`,".site.provision.status",h=>{b.value&&R(h)})}function ae(n){return g.value.get(n)}function le(){}return{provisioningSites:g,deletingSites:c,isConnected:$,connectionError:V,isConfigured:ee,siteReadyCount:D,siteDeletedCount:H,connect:()=>{},disconnect:le,trackSite:ne,getSiteStatus:ae,trackDeletion:j,getDeletionStatus:B,markDeletionComplete:te,markDeletionFailed:se,clearDeletion:q}}const Qe={class:"mb-8 flex items-start justify-between"},Xe={class:"text-zinc-400 mt-1"},Je={key:0,class:"mb-6 p-4 bg-amber-400/10 border border-amber-400/20 rounded-lg flex items-start gap-3"},Ke={class:"text-zinc-400 text-sm mt-1"},Ze={key:0},et={key:1},tt={key:1,class:"border border-zinc-800 rounded-lg p-8 text-center"},st={key:2,class:"border border-zinc-800 rounded-lg p-8 text-center"},nt={key:3,class:"border border-zinc-800 rounded-lg overflow-hidden"},at={class:"flex items-center gap-2"},lt={class:"flex flex-col"},it={class:"font-medium text-white"},ot={key:0,class:"text-zinc-400 text-xs"},rt={key:0,class:"flex items-center gap-2"},ut={key:1,class:"flex items-center gap-2"},dt={key:2,class:"text-xs text-zinc-500"},ct={key:0,class:"text-sm text-zinc-500 font-mono"},ft={key:1,class:"flex items-center gap-2"},mt=["value","onChange","disabled"],pt=["value"],gt={key:0,class:"text-xs text-lime-400"},vt={key:1,class:"text-xs text-red-400"},bt={key:2,class:"text-xs text-zinc-500"},ht={key:3,class:"flex items-center justify-end gap-2"},_t={class:"mt-4 flex items-center gap-6 text-xs text-zinc-500"},xt={class:"flex items-center gap-1.5"},yt={class:"flex items-center gap-1.5"},kt={class:"flex items-center gap-1.5 ml-auto"},wt={key:0,class:"inline-flex items-center gap-1 text-lime-400"},St={key:1,class:"inline-flex items-center gap-1 text-amber-400"},Ct={class:"p-6"},zt={class:"text-zinc-300 mb-4"},Dt={class:"text-white"},$t={key:0,class:"mb-4 p-3 bg-red-400/10 border border-red-400/20 rounded-lg"},Pt={class:"text-red-400 text-sm"},Ft={class:"flex justify-end gap-3"},Bt=Pe({__name:"Sites",props:{environment:{},editor:{},remoteApiUrl:{}},setup(g){const c=g,w=s=>c.remoteApiUrl?`${c.remoteApiUrl}${s}`:`/api/environments/${c.environment.id}${s}`,Z=xe(),b=p([]),ee=["queued","creating_repo","cloning","setting_up","installing_composer","installing_npm","building","finalizing"],D=p(!0),H=p("test"),$=p("8.4"),V=p(["8.3","8.4","8.5"]),S=p(null),R=E(()=>{const s=new Map(b.value.map(e=>[e.name,e]));for(const[e,t]of y.value)s.has(e)||s.set(e,{id:0,name:e,path:`~/sites/${e}`,has_public_folder:!1,php_version:$.value,status:t.status});return Array.from(s.values()).sort((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))}),{provisioningSites:y,deletingSites:U,isConnected:j,connectionError:B,siteReadyCount:te,siteDeletedCount:se,isConfigured:q,trackSite:ne,getSiteStatus:ae,trackDeletion:le,getDeletionStatus:n,markDeletionComplete:h,markDeletionFailed:de}=Ge(),ce=E(()=>{const s=Z.props.flash;return s?.provisioning?s.provisioning:new URLSearchParams(window.location.search).get("provisioning")}),fe={queued:"Queued...",provisioning:"Initializing...",creating_repo:"Creating repository...",cloning:"Cloning...",setting_up:"Setting up...",installing_composer:"Installing Composer...",installing_npm:"Installing dependencies...",building:"Building assets...",finalizing:"Finalizing...",ready:"Ready",failed:"Failed"},ye={deleting:"Deleting...",removing_files:"Removing files...",deleted:"Deleted",delete_failed:"Delete failed"};function Y(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")}function k(s){const e=Y(s),t=n(e);return t?t.status!=="delete_failed":!1}function _(s){const e=Y(s);return n(e)?.status??null}function me(s){if(s.status&&ee.includes(s.status))return{slug:s.name,status:s.status,error:s.error_message??null,siteId:s.id};const e=s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");return ae(e)??null}function P(s){const e=me(s);return e?e.status!=="ready"&&e.status!=="failed":!1}function F(s){const e=me(s);return e?.status==="ready"?null:e?.status??null}function ie(s,e){const t=s||"Unknown error";if(t.includes("Connection error"))x.error("Connection Error",{description:"Could not connect to the environment. Check if Orbit is running."});else{const m=e.charAt(0).toUpperCase()+e.slice(1)+" Failed";x.error(m,{description:t})}}async function A(s=!1){s||(D.value=!0);try{const{data:e}=await X.get(w("/sites"));e.success&&e.data?(b.value=e.data.sites||[],H.value=e.data.tld||"test",$.value=e.data.default_php_version||"8.4",e.data.available_php_versions?.length&&(V.value=e.data.available_php_versions)):!e.success&&!s&&ie(e.error,"load sites")}catch(e){if(Me.isCancel(e))return;console.error("Failed to load sites:",e)}finally{s||(D.value=!1)}}function ke(s){const e=`https://${s}`;window.open(e,"_blank")}function we(s){let e;if(c.environment.is_local)e=`${c.editor.scheme}://file${s}`;else{const t=`${c.environment.user}@${c.environment.host}`;e=`${c.editor.scheme}://vscode-remote/ssh-remote+${t}${s}?windowId=_blank`}window.open(e,"_blank")}async function Se(s,e){if(s.domain){S.value=s.name;try{const{data:t}=await X.post(w(`/php/${s.name}`),{version:e});t.success?(x.success("PHP Version Changed",{description:`Now using PHP ${e} for this site.`}),await A(!0)):ie(t.error,"change PHP version")}catch{}finally{S.value=null}}}const I=p(!1),T=p(null),M=p(!1),O=p(null);function Ce(s){T.value=s,O.value=null,I.value=!0}async function ze(){if(!T.value)return;const s=T.value.name,e=Y(s);j.value||x.warning("Real-time updates unavailable",{description:"Deletion will proceed but you may need to refresh the page to see updated status."}),I.value=!1,le(e),T.value=null,M.value=!1,O.value=null;try{const{data:t}=await X.delete(w(`/sites/${e}`));t.success?(h(e),await A(!0)):de(e,t.error||"Failed to delete site")}catch(t){console.error("Failed to delete site:",t),de(e,"An error occurred while deleting the site")}}const W=p(null);async function De(s){W.value=s.name;const e=Y(s.name);try{const{data:t}=await X.post(w(`/sites/${e}/rebuild`),{});t.success?(x.success("Site Rebuilt",{description:`"${s.name}" has been rebuilt successfully.`}),await A(!0)):ie(t.error,"rebuild site")}catch{}finally{W.value=null}}return Q(te,()=>{for(const[s,e]of y.value)if(e.status==="ready"){x.success("Site Created",{description:`"${s}" has been created successfully.`});break}setTimeout(()=>{A(!0)},500)}),Q(se,()=>{for(const[s,e]of U.value)if(e.status==="deleted"){x.success("Site Deleted",{description:`"${s}" has been removed.`});break}setTimeout(()=>{A(!0)},500)}),Q(()=>[...y.value.values()],(s,e)=>{for(const t of s){const m=e?.find(oe=>oe.slug===t.slug);t.status==="failed"&&m?.status!=="failed"&&x.error(`Failed to create site "${t.slug}"`,{description:t.error||"Unknown error occurred"})}},{deep:!0}),Q(()=>[...U.value.values()],(s,e)=>{for(const t of s){const m=e?.find(oe=>oe.slug===t.slug);t.status==="delete_failed"&&m?.status!=="delete_failed"&&x.error(`Failed to delete site "${t.slug}"`,{description:t.error||"Unknown error occurred"})}},{deep:!0}),Fe(()=>{ce.value&&ne(ce.value),A()}),(s,e)=>(l(),u(re,null,[o(a(Ae),{title:`Sites - ${g.environment.name}`},null,8,["title"]),i("div",null,[i("div",Qe,[i("div",null,[o(Ne,{title:"Sites"}),i("p",Xe,"Sites in "+v(g.environment.name),1)]),o(a(z),{"as-child":"",variant:"secondary"},{default:r(()=>[o(a(Le),{href:`/environments/${g.environment.id}/sites/create`},{default:r(()=>[o(a(Ee),{class:"w-4 h-4"}),e[2]||(e[2]=f(" New Site ",-1))]),_:1},8,["href"])]),_:1})]),a(B)||!a(q)?(l(),u("div",Je,[o(a(ve),{class:"w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5"}),i("div",null,[e[3]||(e[3]=i("p",{class:"text-amber-400 font-medium"},"Real-time updates unavailable",-1)),i("p",Ke,[a(q)?(l(),u("span",et," Could not connect to WebSocket: "+v(a(B))+". Status updates for provisioning and deletion will not appear automatically. ",1)):(l(),u("span",Ze," Reverb is not configured for this environment. Status updates for provisioning and deletion will not appear automatically. "))])])])):C("",!0),D.value?(l(),u("div",tt,[o(a(L),{class:"w-8 h-8 mx-auto text-zinc-600 animate-spin mb-3"}),e[4]||(e[4]=i("p",{class:"text-zinc-500"},"Loading sites...",-1))])):R.value.length===0?(l(),u("div",st,[o(a(ue),{class:"w-12 h-12 mx-auto text-zinc-600 mb-3"}),e[5]||(e[5]=i("h3",{class:"text-lg font-medium text-white mb-2"},"No sites found",-1)),e[6]||(e[6]=i("p",{class:"text-zinc-400"},"Add site directories in the environment configuration.",-1))])):(l(),u("div",nt,[o(a(Be),null,{default:r(()=>[o(a(Ve),null,{default:r(()=>[o(a(ge),null,{default:r(()=>[o(a(J),null,{default:r(()=>[...e[7]||(e[7]=[f("Site",-1)])]),_:1}),o(a(J),null,{default:r(()=>[...e[8]||(e[8]=[f("Status",-1)])]),_:1}),o(a(J),null,{default:r(()=>[...e[9]||(e[9]=[f("PHP",-1)])]),_:1}),o(a(J),{class:"text-right"},{default:r(()=>[...e[10]||(e[10]=[f("Actions",-1)])]),_:1})]),_:1})]),_:1}),o(a(je),null,{default:r(()=>[(l(!0),u(re,null,pe(R.value,t=>(l(),d(a(ge),{key:t.name,class:Re({"opacity-50":k(t.name),"bg-zinc-900/50":P(t),"bg-lime-900/20":_(t.name)==="deleted","bg-red-900/20":k(t.name)&&_(t.name)!=="deleted"})},{default:r(()=>[o(a(K),null,{default:r(()=>[i("div",at,[_(t.name)==="deleted"?(l(),d(a(Ue),{key:0,class:"w-4 h-4 text-lime-400"})):k(t.name)?(l(),d(a(L),{key:1,class:"w-4 h-4 text-red-400 animate-spin"})):P(t)?(l(),d(a(L),{key:2,class:"w-4 h-4 text-amber-400 animate-spin"})):F(t)==="queued"?(l(),d(a(We),{key:3,class:"w-4 h-4 text-blue-400"})):F(t)==="failed"||_(t.name)==="delete_failed"?(l(),d(a(ve),{key:4,class:"w-4 h-4 text-red-400"})):t.site_type==="laravel-package"?(l(),d(a(qe),{key:5,class:"w-4 h-4 text-purple-400"})):t.site_type==="cli"?(l(),d(a(Ie),{key:6,class:"w-4 h-4 text-amber-400"})):t.has_public_folder?(l(),d(a(be),{key:7,class:"w-4 h-4 text-lime-400"})):(l(),d(a(ue),{key:8,class:"w-4 h-4 text-zinc-400"})),i("div",lt,[i("span",it,v(t.display_name||t.name),1),t.github_repo&&!P(t)&&!k(t.name)?(l(),u("span",ot,v(t.github_repo),1)):C("",!0)])])]),_:2},1024),o(a(K),null,{default:r(()=>[_(t.name)?(l(),u("div",rt,[_(t.name)==="deleted"?(l(),d(a(N),{key:0,class:"bg-lime-400/10 text-lime-400 border-lime-400/20"},{default:r(()=>[...e[11]||(e[11]=[f(" Deleted ",-1)])]),_:1})):_(t.name)==="delete_failed"?(l(),d(a(N),{key:1,class:"bg-red-400/10 text-red-400 border-red-400/20"},{default:r(()=>[...e[12]||(e[12]=[f(" Delete failed ",-1)])]),_:1})):k(t.name)?(l(),d(a(N),{key:2,class:"bg-red-400/10 text-red-400 border-red-400/20"},{default:r(()=>[f(v(ye[_(t.name)]),1)]),_:2},1024)):C("",!0)])):F(t)?(l(),u("div",ut,[F(t)==="failed"?(l(),d(a(N),{key:0,class:"bg-red-400/10 text-red-400 border-red-400/20"},{default:r(()=>[...e[13]||(e[13]=[f(" Failed ",-1)])]),_:1})):(l(),d(a(N),{key:1,class:"bg-amber-400/10 text-amber-400 border-amber-400/20"},{default:r(()=>[f(v(fe[F(t)]),1)]),_:2},1024))])):(l(),u("span",dt,"â€”"))]),_:2},1024),o(a(K),null,{default:r(()=>[P(t)||k(t.name)?(l(),u("div",ct,v(t.php_version||$.value),1)):S.value===t.name?(l(),u("div",ft,[o(a(L),{class:"w-4 h-4 text-zinc-400 animate-spin"}),e[14]||(e[14]=i("span",{class:"text-sm text-zinc-500"},"Changing...",-1))])):(l(),u("select",{key:2,value:t.php_version||$.value,onChange:m=>Se(t,m.target.value),class:"text-xs py-1 pl-2 pr-7 font-mono bg-zinc-800 border-zinc-700 rounded",disabled:!t.has_public_folder},[(l(!0),u(re,null,pe(V.value,m=>(l(),u("option",{key:m,value:m}," PHP "+v(m),9,pt))),128))],40,mt))]),_:2},1024),o(a(K),{class:"text-right"},{default:r(()=>[_(t.name)==="deleted"?(l(),u("div",gt," Deleted ")):k(t.name)?(l(),u("div",vt," Deleting... ")):P(t)?(l(),u("div",bt,v(fe[F(t)??"provisioning"]),1)):(l(),u("div",ht,[t.has_public_folder&&t.domain?(l(),d(a(z),{key:0,onClick:m=>ke(t.domain),variant:"secondary",size:"sm"},{default:r(()=>[o(a(Te),{class:"w-3.5 h-3.5"}),e[15]||(e[15]=f(" Open ",-1))]),_:1},8,["onClick"])):C("",!0),s.$page.props.multi_environment?(l(),d(a(z),{key:1,onClick:m=>we(t.path),variant:"outline",size:"sm"},{default:r(()=>[o(a(Ye),{class:"w-3.5 h-3.5"}),f(" "+v(g.editor.name),1)]),_:1},8,["onClick"])):C("",!0),t.has_public_folder&&!P(t)&&!k(t.name)?(l(),d(a(z),{key:2,onClick:m=>De(t),variant:"ghost",size:"icon-sm",class:"text-zinc-500 hover:text-amber-400",disabled:W.value===t.name,title:"Rebuild site (reinstall deps, build assets)"},{default:r(()=>[W.value===t.name?(l(),d(a(L),{key:0,class:"w-3.5 h-3.5 animate-spin"})):(l(),d(a(Oe),{key:1,class:"w-3.5 h-3.5"}))]),_:2},1032,["onClick","disabled"])):C("",!0),o(a(z),{onClick:m=>Ce(t),variant:"ghost",size:"icon-sm",class:"text-zinc-500 hover:text-red-400",title:"Delete site"},{default:r(()=>[o(a(he),{class:"w-3.5 h-3.5"})]),_:1},8,["onClick"])]))]),_:2},1024)]),_:2},1032,["class"]))),128))]),_:1})]),_:1})])),i("div",_t,[i("div",xt,[o(a(be),{class:"w-3.5 h-3.5 text-lime-400"}),e[16]||(e[16]=i("span",null,"Has public folder",-1))]),i("div",yt,[o(a(ue),{class:"w-3.5 h-3.5 text-zinc-500"}),e[17]||(e[17]=i("span",null,"No public folder",-1))]),i("div",kt,[a(j)?(l(),u("span",wt,[...e[18]||(e[18]=[i("span",{class:"w-1.5 h-1.5 rounded-full bg-lime-400"},null,-1),f(" Live updates ",-1)])])):(l(),u("span",St,[...e[19]||(e[19]=[i("span",{class:"w-1.5 h-1.5 rounded-full bg-amber-400"},null,-1),f(" No live updates ",-1)])]))])]),o(He,{show:I.value,title:"Delete Site",onClose:e[1]||(e[1]=t=>I.value=!1)},{default:r(()=>[i("div",Ct,[i("p",zt,[e[20]||(e[20]=f(" Are you sure you want to delete ",-1)),i("strong",Dt,v(T.value?.name),1),e[21]||(e[21]=f("? ",-1))]),e[23]||(e[23]=i("p",{class:"text-zinc-400 text-sm mb-4"},"This will:",-1)),e[24]||(e[24]=i("ul",{class:"text-zinc-400 text-sm mb-6 list-disc list-inside space-y-1"},[i("li",null,"Remove the site directory from the server")],-1)),e[25]||(e[25]=i("p",{class:"text-red-400 text-sm mb-6"},"This action cannot be undone.",-1)),O.value?(l(),u("div",$t,[i("p",Pt,v(O.value),1)])):C("",!0),i("div",Ft,[o(a(z),{onClick:e[0]||(e[0]=t=>I.value=!1),variant:"outline",disabled:M.value},{default:r(()=>[...e[22]||(e[22]=[f(" Cancel ",-1)])]),_:1},8,["disabled"]),o(a(z),{onClick:ze,variant:"destructive",disabled:M.value},{default:r(()=>[M.value?(l(),d(a(L),{key:0,class:"w-4 h-4 animate-spin"})):(l(),d(a(he),{key:1,class:"w-4 h-4"})),f(" "+v(M.value?"Deleting...":"Delete Site"),1)]),_:1},8,["disabled"])])])]),_:1},8,["show"])])],64))}});export{Bt as default};
