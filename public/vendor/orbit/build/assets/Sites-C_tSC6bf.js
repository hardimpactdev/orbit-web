import{I as ge,L as ze,s as R,N as W,r as p,O as ve,d as Se,k as Q,M as x,y as Ce,c as o,g as u,a,u as l,h as $e,f as L,t as f,w as h,l as De,b as y,P as Pe,W as Fe,F as X,i as ce,o as i,e as d,U as Le,n as Ee,H as Re,X as Ae,E as Ie}from"./app-B3a6RFBA.js";import{a as J}from"./axios-C_G7uDe6.js";import{_ as Ne}from"./Modal.vue_vue_type_script_setup_true_lang-B7--Ro30.js";import{I as S}from"./craft-ui-DyvEPCxV.js";import{C as pe}from"./circle-alert-9TtTjYpl.js";import{L as E}from"./loader-circle-DAxsOTxC.js";import{G as me}from"./globe-CpLIHy60.js";import{T as fe}from"./trash-2-C0PxlOCX.js";import{P as Te}from"./package-BsvRVkkp.js";import{C as He}from"./code-BKTwxs91.js";import{R as Me}from"./refresh-cw-BxYmm0t-.js";const Ve=ge("clock-3",[["path",{d:"M12 6v6h4",key:"135r8i"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);const le=ge("folder-open",[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]]);function Ue(){const m=p(new Map),r=p(new Map),w=ze(),K=ve(),g=R(()=>!!K.props.reverb?.enabled),Y=R(()=>g.value),C=p(0),M=p(0),$=R(()=>g.value&&w.value==="connected"),V=R(()=>g.value&&w.value==="failed"?"Reverb connection unavailable":null),z=new Map;function A(n){if(z.get(n.slug)===n.status)return;z.set(n.slug,n.status);const v=m.value.get(n.slug);m.value.set(n.slug,{slug:n.slug,status:n.status,error:n.error,siteId:n.site_id??v?.siteId}),(n.status==="ready"||n.status==="failed")&&(n.status==="ready"&&C.value++,setTimeout(()=>{m.value.delete(n.slug),z.delete(n.slug)},15e3))}g.value&&(W("provisioning",".site.provision.status",A),W("provisioning",".site.deletion.status",I));const b=new Map;function I(n){b.get(n.slug)!==n.status&&(b.set(n.slug,n.status),r.value.set(n.slug,{slug:n.slug,status:n.status,error:n.error}),(n.status==="deleted"||n.status==="delete_failed")&&(n.status==="deleted"&&M.value++,setTimeout(()=>{r.value.delete(n.slug),b.delete(n.slug)},2e3)))}function U(n){r.value.has(n)||r.value.set(n,{slug:n,status:"deleting"}),W(`site.${n}`,".site.deletion.status",v=>{g.value&&I(v)})}function B(n){return r.value.get(n)}function Z(n){r.value.set(n,{slug:n,status:"deleted"}),setTimeout(()=>{r.value.delete(n)},2e3)}function ee(n,v){r.value.set(n,{slug:n,status:"delete_failed",error:v})}function O(n){r.value.delete(n),b.delete(n)}function te(n){m.value.has(n)||m.value.set(n,{slug:n,status:"provisioning"}),W(`site.${n}`,".site.provision.status",v=>{g.value&&A(v)})}function se(n){return m.value.get(n)}function ne(){}return{provisioningSites:m,deletingSites:r,isConnected:$,connectionError:V,isConfigured:Y,siteReadyCount:C,siteDeletedCount:M,connect:()=>{},disconnect:ne,trackSite:te,getSiteStatus:se,trackDeletion:U,getDeletionStatus:B,markDeletionComplete:Z,markDeletionFailed:ee,clearDeletion:O}}const Be={class:"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between mb-8"},Oe={class:"text-sm text-zinc-500 mt-1"},je={class:"flex items-center gap-2"},qe={key:0,class:"mb-6 p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg flex items-start gap-3"},Ge={class:"text-zinc-400 text-sm mt-1"},We={key:0},Qe={key:1},Xe={key:1,class:"rounded-lg border border-zinc-800 bg-zinc-900/50 p-8 text-center"},Je={key:2,class:"rounded-lg border border-zinc-800 bg-zinc-900/50 p-8 text-center"},Ke={key:3,class:"rounded-lg border border-zinc-800 bg-zinc-900/50 overflow-hidden"},Ye={class:"flex items-center gap-3 min-w-0"},Ze={class:"min-w-0"},et={class:"font-medium text-sm text-zinc-100 truncate"},tt={key:0,class:"text-xs text-zinc-500 truncate"},st={class:"text-sm"},nt={key:0,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-lime-500/15 text-lime-400"},it={key:1,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-500/15 text-red-400"},at={key:2,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-500/15 text-red-400"},lt={key:3,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-red-500/15 text-red-400"},ot={key:4,class:"px-2 py-0.5 text-xs font-medium rounded-full bg-amber-500/15 text-amber-400"},rt={key:5,class:"text-zinc-500/50"},ut={key:0,class:"text-sm text-zinc-500 font-mono"},dt={key:1,class:"flex items-center gap-2"},ct=["value","onChange","disabled"],pt=["value"],mt={class:"flex items-center justify-end gap-1"},ft={key:0,class:"text-xs text-lime-400"},gt={key:1,class:"text-xs text-red-400"},vt={key:2,class:"text-xs text-zinc-500"},xt={class:"flex items-center gap-0.5 opacity-60 hover:opacity-100 transition-opacity"},ht={class:"flex items-center justify-between mt-4 px-1"},bt={class:"flex items-center gap-4 text-xs text-zinc-500"},_t={class:"flex items-center gap-1.5"},kt={class:"flex items-center gap-1.5"},yt={class:"flex items-center gap-1.5 text-xs"},wt={key:0,class:"inline-flex items-center gap-1.5 text-lime-400"},zt={key:1,class:"inline-flex items-center gap-1.5 text-amber-400"},St={class:"p-6"},Ct={class:"text-zinc-300 mb-4"},$t={class:"text-white"},Dt={key:0,class:"mb-4 p-3 bg-red-400/10 border border-red-400/20 rounded-lg"},Pt={class:"text-red-400 text-sm"},Ft={class:"flex justify-end gap-3"},Bt=Se({__name:"Sites",props:{environment:{},editor:{},remoteApiUrl:{}},setup(m){const r=m,w=s=>r.remoteApiUrl?`${r.remoteApiUrl}${s}`:`/api/environments/${r.environment.id}${s}`,K=ve(),g=p([]),Y=["queued","creating_repo","cloning","setting_up","installing_composer","installing_npm","building","finalizing"],C=p(!0),M=p("test"),$=p("8.4"),V=p(["8.3","8.4","8.5"]),z=p(null),A=R(()=>{const s=new Map(g.value.map(e=>[e.name,e]));for(const[e,t]of b.value)s.has(e)||s.set(e,{id:0,name:e,path:`~/sites/${e}`,has_public_folder:!1,php_version:$.value,status:t.status});return Array.from(s.values()).sort((e,t)=>e.name.toLowerCase().localeCompare(t.name.toLowerCase()))}),{provisioningSites:b,deletingSites:I,isConnected:U,connectionError:B,siteReadyCount:Z,siteDeletedCount:ee,isConfigured:O,trackSite:te,getSiteStatus:se,trackDeletion:ne,getDeletionStatus:n,markDeletionComplete:v,markDeletionFailed:oe}=Ue(),re=R(()=>{const s=K.props.flash;return s?.provisioning?s.provisioning:new URLSearchParams(window.location.search).get("provisioning")}),ue={queued:"Queued...",provisioning:"Initializing...",creating_repo:"Creating repository...",cloning:"Cloning...",setting_up:"Setting up...",installing_composer:"Installing Composer...",installing_npm:"Installing dependencies...",building:"Building assets...",finalizing:"Finalizing...",ready:"Ready",failed:"Failed"},xe={deleting:"Deleting...",removing_files:"Removing files...",deleted:"Deleted",delete_failed:"Delete failed"};function j(s){return s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"")}function _(s){const e=j(s),t=n(e);return t?t.status!=="delete_failed":!1}function k(s){const e=j(s);return n(e)?.status??null}function de(s){if(s.status&&Y.includes(s.status))return{slug:s.name,status:s.status,error:s.error_message??null,siteId:s.id};const e=s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");return se(e)??null}function D(s){const e=de(s);return e?e.status!=="ready"&&e.status!=="failed":!1}function P(s){const e=de(s);return e?.status==="ready"?null:e?.status??null}function ie(s,e){const t=s||"Unknown error";if(t.includes("Connection error"))x.error("Connection Error",{description:"Could not connect to the environment. Check if Orbit is running."});else{const c=e.charAt(0).toUpperCase()+e.slice(1)+" Failed";x.error(c,{description:t})}}async function F(s=!1){s||(C.value=!0);try{const{data:e}=await J.get(w("/sites"));e.success&&e.data?(g.value=e.data.sites||[],M.value=e.data.tld||"test",$.value=e.data.default_php_version||"8.4",e.data.available_php_versions?.length&&(V.value=e.data.available_php_versions)):!e.success&&!s&&ie(e.error,"load sites")}catch(e){if(Le.isCancel(e))return;console.error("Failed to load sites:",e)}finally{s||(C.value=!1)}}function he(s){const e=`https://${s}`;window.open(e,"_blank")}function be(s){let e;if(r.environment.is_local)e=`${r.editor.scheme}://file${s}`;else{const t=`${r.environment.user}@${r.environment.host}`;e=`${r.editor.scheme}://vscode-remote/ssh-remote+${t}${s}?windowId=_blank`}window.open(e,"_blank")}async function _e(s,e){if(s.domain){z.value=s.name;try{const{data:t}=await J.post(w(`/php/${s.name}`),{version:e});t.success?(x.success("PHP Version Changed",{description:`Now using PHP ${e} for this site.`}),await F(!0)):ie(t.error,"change PHP version")}catch{}finally{z.value=null}}}const N=p(!1),T=p(null),H=p(!1),q=p(null);function ke(s){T.value=s,q.value=null,N.value=!0}async function ye(){if(!T.value)return;const s=T.value.name,e=j(s);U.value||x.warning("Real-time updates unavailable",{description:"Deletion will proceed but you may need to refresh the page to see updated status."}),N.value=!1,ne(e),T.value=null,H.value=!1,q.value=null;try{const{data:t}=await J.delete(w(`/sites/${e}`));t.success?(v(e),await F(!0)):oe(e,t.error||"Failed to delete site")}catch(t){console.error("Failed to delete site:",t),oe(e,"An error occurred while deleting the site")}}const G=p(null);async function we(s){G.value=s.name;const e=j(s.name);try{const{data:t}=await J.post(w(`/sites/${e}/rebuild`),{});t.success?(x.success("Site Rebuilt",{description:`"${s.name}" has been rebuilt successfully.`}),await F(!0)):ie(t.error,"rebuild site")}catch{}finally{G.value=null}}return Q(Z,()=>{for(const[s,e]of b.value)if(e.status==="ready"){x.success("Site Created",{description:`"${s}" has been created successfully.`});break}setTimeout(()=>{F(!0)},500)}),Q(ee,()=>{for(const[s,e]of I.value)if(e.status==="deleted"){x.success("Site Deleted",{description:`"${s}" has been removed.`});break}setTimeout(()=>{F(!0)},500)}),Q(()=>[...b.value.values()],(s,e)=>{for(const t of s){const c=e?.find(ae=>ae.slug===t.slug);t.status==="failed"&&c?.status!=="failed"&&x.error(`Failed to create site "${t.slug}"`,{description:t.error||"Unknown error occurred"})}},{deep:!0}),Q(()=>[...I.value.values()],(s,e)=>{for(const t of s){const c=e?.find(ae=>ae.slug===t.slug);t.status==="delete_failed"&&c?.status!=="delete_failed"&&x.error(`Failed to delete site "${t.slug}"`,{description:t.error||"Unknown error occurred"})}},{deep:!0}),Ce(()=>{re.value&&te(re.value),F()}),(s,e)=>(i(),o(X,null,[u(l($e),{title:`Sites - ${m.environment.name}`},null,8,["title"]),a("div",null,[a("header",Be,[a("div",null,[e[2]||(e[2]=a("h1",{class:"text-2xl font-semibold tracking-tight text-zinc-100"},"Sites",-1)),a("p",Oe,"Sites in "+f(m.environment.name),1)]),a("div",je,[u(l(S),{"as-child":"",size:"sm",class:"bg-lime-500 hover:bg-lime-600 text-zinc-950"},{default:h(()=>[u(l(De),{href:`/environments/${m.environment.id}/sites/create`},{default:h(()=>[u(l(Pe),{class:"w-4 h-4 mr-1.5"}),e[3]||(e[3]=y(" New Site ",-1))]),_:1},8,["href"])]),_:1})])]),l(B)||!l(O)?(i(),o("div",qe,[u(l(pe),{class:"w-5 h-5 text-amber-400 flex-shrink-0 mt-0.5"}),a("div",null,[e[4]||(e[4]=a("p",{class:"text-amber-400 font-medium text-sm"},"Real-time updates unavailable",-1)),a("p",Ge,[l(O)?(i(),o("span",Qe," Could not connect to WebSocket: "+f(l(B))+". Status updates for provisioning and deletion will not appear automatically. ",1)):(i(),o("span",We," Reverb is not configured for this environment. Status updates for provisioning and deletion will not appear automatically. "))])])])):L("",!0),C.value?(i(),o("div",Xe,[u(l(E),{class:"w-8 h-8 mx-auto text-zinc-600 animate-spin mb-3"}),e[5]||(e[5]=a("p",{class:"text-zinc-500"},"Loading sites...",-1))])):A.value.length===0?(i(),o("div",Je,[u(l(le),{class:"w-12 h-12 mx-auto text-zinc-600 mb-3"}),e[6]||(e[6]=a("h3",{class:"text-lg font-medium text-zinc-100 mb-2"},"No sites found",-1)),e[7]||(e[7]=a("p",{class:"text-zinc-400"},"Add site directories in the environment configuration.",-1))])):(i(),o("div",Ke,[e[10]||(e[10]=Fe('<div class="grid grid-cols-[1fr_100px_140px_160px] items-center gap-4 px-4 py-3 border-b border-zinc-800 bg-zinc-800/30"><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">Site</span><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">Status</span><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide">PHP</span><span class="text-xs font-medium text-zinc-500 uppercase tracking-wide text-right">Actions</span></div>',1)),a("div",null,[(i(!0),o(X,null,ce(A.value,t=>(i(),o("div",{key:t.name,class:Ee(["grid grid-cols-[1fr_100px_140px_160px] items-center gap-4 px-4 py-3 border-b border-zinc-800/50 last:border-b-0 transition-colors hover:bg-zinc-800/30",{"opacity-50":_(t.name),"bg-zinc-800/20":D(t),"bg-lime-500/5":k(t.name)==="deleted","bg-red-500/5":_(t.name)&&k(t.name)!=="deleted"}])},[a("div",Ye,[k(t.name)==="deleted"?(i(),d(l(Re),{key:0,class:"w-4 h-4 shrink-0 text-lime-400"})):_(t.name)?(i(),d(l(E),{key:1,class:"w-4 h-4 shrink-0 text-red-400 animate-spin"})):D(t)?(i(),d(l(E),{key:2,class:"w-4 h-4 shrink-0 text-amber-400 animate-spin"})):P(t)==="queued"?(i(),d(l(Ve),{key:3,class:"w-4 h-4 shrink-0 text-blue-400"})):P(t)==="failed"||k(t.name)==="delete_failed"?(i(),d(l(pe),{key:4,class:"w-4 h-4 shrink-0 text-red-400"})):t.site_type==="laravel-package"?(i(),d(l(Te),{key:5,class:"w-4 h-4 shrink-0 text-purple-400"})):t.site_type==="cli"?(i(),d(l(Ae),{key:6,class:"w-4 h-4 shrink-0 text-amber-400"})):t.has_public_folder?(i(),d(l(me),{key:7,class:"w-4 h-4 shrink-0 text-lime-400"})):(i(),d(l(le),{key:8,class:"w-4 h-4 shrink-0 text-zinc-500"})),a("div",Ze,[a("p",et,f(t.display_name||t.name),1),t.github_repo&&!D(t)&&!_(t.name)?(i(),o("p",tt,f(t.github_repo),1)):L("",!0)])]),a("div",st,[k(t.name)==="deleted"?(i(),o("span",nt," Deleted ")):k(t.name)==="delete_failed"?(i(),o("span",it," Failed ")):_(t.name)?(i(),o("span",at,f(xe[k(t.name)]),1)):P(t)==="failed"?(i(),o("span",lt," Failed ")):P(t)?(i(),o("span",ot,f(ue[P(t)]),1)):(i(),o("span",rt,"â€”"))]),a("div",null,[D(t)||_(t.name)?(i(),o("div",ut,f(t.php_version||$.value),1)):z.value===t.name?(i(),o("div",dt,[u(l(E),{class:"w-4 h-4 text-zinc-400 animate-spin"}),e[8]||(e[8]=a("span",{class:"text-sm text-zinc-500"},"...",-1))])):(i(),o("select",{key:2,value:t.php_version||$.value,onChange:c=>_e(t,c.target.value),class:"h-8 w-[110px] text-xs py-1 pl-2 pr-7 font-mono bg-zinc-800/50 border border-zinc-700 rounded-md text-zinc-100 hover:bg-zinc-800",disabled:!t.has_public_folder},[(i(!0),o(X,null,ce(V.value,c=>(i(),o("option",{key:c,value:c}," PHP "+f(c),9,pt))),128))],40,ct))]),a("div",mt,[k(t.name)==="deleted"?(i(),o("div",ft," Deleted ")):_(t.name)?(i(),o("div",gt," Deleting... ")):D(t)?(i(),o("div",vt,f(ue[P(t)??"provisioning"]),1)):(i(),o(X,{key:3},[t.has_public_folder&&t.domain?(i(),d(l(S),{key:0,onClick:c=>he(t.domain),variant:"outline",size:"sm",class:"h-8 px-3 bg-transparent border-zinc-700 text-zinc-300 hover:bg-zinc-800"},{default:h(()=>[u(l(Ie),{class:"w-3.5 h-3.5 mr-1.5"}),e[9]||(e[9]=y(" Open ",-1))]),_:1},8,["onClick"])):L("",!0),a("div",xt,[s.$page.props.multi_environment?(i(),d(l(S),{key:0,onClick:c=>be(t.path),variant:"ghost",size:"icon-sm",class:"h-8 w-8 text-zinc-400 hover:text-zinc-200 hover:bg-zinc-800",title:`Open in ${m.editor.name}`},{default:h(()=>[u(l(He),{class:"w-3.5 h-3.5"})]),_:1},8,["onClick","title"])):L("",!0),t.has_public_folder&&!D(t)&&!_(t.name)?(i(),d(l(S),{key:1,onClick:c=>we(t),variant:"ghost",size:"icon-sm",class:"h-8 w-8 text-zinc-400 hover:text-amber-400 hover:bg-zinc-800",disabled:G.value===t.name,title:"Rebuild site"},{default:h(()=>[G.value===t.name?(i(),d(l(E),{key:0,class:"w-3.5 h-3.5 animate-spin"})):(i(),d(l(Me),{key:1,class:"w-3.5 h-3.5"}))]),_:2},1032,["onClick","disabled"])):L("",!0),u(l(S),{onClick:c=>ke(t),variant:"ghost",size:"icon-sm",class:"h-8 w-8 text-zinc-400 hover:text-red-400 hover:bg-red-500/10",title:"Delete site"},{default:h(()=>[u(l(fe),{class:"w-3.5 h-3.5"})]),_:1},8,["onClick"])])],64))])],2))),128))])])),a("div",ht,[a("div",bt,[a("div",_t,[u(l(me),{class:"h-3.5 w-3.5 text-lime-400"}),e[11]||(e[11]=a("span",null,"Has public folder",-1))]),a("div",kt,[u(l(le),{class:"h-3.5 w-3.5"}),e[12]||(e[12]=a("span",null,"No public folder",-1))])]),a("div",yt,[l(U)?(i(),o("span",wt,[...e[13]||(e[13]=[a("span",{class:"w-2 h-2 rounded-full bg-lime-400"},null,-1),y(" Live updates ",-1)])])):(i(),o("span",zt,[...e[14]||(e[14]=[a("span",{class:"w-2 h-2 rounded-full bg-amber-400"},null,-1),y(" No live updates ",-1)])]))])]),u(Ne,{show:N.value,title:"Delete Site",onClose:e[1]||(e[1]=t=>N.value=!1)},{default:h(()=>[a("div",St,[a("p",Ct,[e[15]||(e[15]=y(" Are you sure you want to delete ",-1)),a("strong",$t,f(T.value?.name),1),e[16]||(e[16]=y("? ",-1))]),e[18]||(e[18]=a("p",{class:"text-zinc-400 text-sm mb-4"},"This will:",-1)),e[19]||(e[19]=a("ul",{class:"text-zinc-400 text-sm mb-6 list-disc list-inside space-y-1"},[a("li",null,"Remove the site directory from the server")],-1)),e[20]||(e[20]=a("p",{class:"text-red-400 text-sm mb-6"},"This action cannot be undone.",-1)),q.value?(i(),o("div",Dt,[a("p",Pt,f(q.value),1)])):L("",!0),a("div",Ft,[u(l(S),{onClick:e[0]||(e[0]=t=>N.value=!1),variant:"outline",disabled:H.value},{default:h(()=>[...e[17]||(e[17]=[y(" Cancel ",-1)])]),_:1},8,["disabled"]),u(l(S),{onClick:ye,variant:"destructive",disabled:H.value},{default:h(()=>[H.value?(i(),d(l(E),{key:0,class:"w-4 h-4 animate-spin"})):(i(),d(l(fe),{key:1,class:"w-4 h-4"})),y(" "+f(H.value?"Deleting...":"Delete Site"),1)]),_:1},8,["disabled"])])])]),_:1},8,["show"])])],64))}});export{Bt as default};
